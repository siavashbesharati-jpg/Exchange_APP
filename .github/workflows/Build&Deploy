name: ğŸš€ Deploy .NET App to VPS
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ Ø¨Ø±Ø¯Ø§Ø´ØªÙ† Ú©Ø¯ Ø§Ø² Ø±ÛŒÙ¾Ùˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Ø¨ÛŒÙ„Ø¯ Ø¯Ø§Øªâ€ŒÙ†Øª
      - name: Build .NET app
        run: dotnet publish -c Release -o publish

      # 3ï¸âƒ£ ØªÙˆÙ‚Ù Ø³Ø±ÙˆÛŒØ³ Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± Ù‚Ø¨Ù„ Ø§Ø² Ø¢Ù¾Ù„ÙˆØ¯
      - name: Stop .NET service
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            sudo systemctl stop ${{ vars.SERVICE_NAME }}

      # 4ï¸âƒ£ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ù‡ Ø³Ø±ÙˆØ±
      - name: Upload files to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          source: "publish/*"
          target: ${{ vars.PROJECT_PATH }}

      # 5ï¸âƒ£ Ø±ÛŒâ€ŒØ§Ø³ØªØ§Ø±Øª Ø³Ø±ÙˆÛŒØ³ Ø¨Ø¹Ø¯ Ø§Ø² Ø¢Ù¾Ù„ÙˆØ¯
      - name: Restart .NET service
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            sudo systemctl start ${{ vars.SERVICE_NAME }}
