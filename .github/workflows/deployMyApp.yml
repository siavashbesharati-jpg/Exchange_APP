name: "üöÄ Deploy My App with Debug"

on:
  push:
    branches: [ master ]  # make sure this is your real main branch

jobs:
  deploy:
    runs-on: [self-hosted, linux, x64]

    steps:
      # -----------------------------
      # 1Ô∏è‚É£ Checkout code
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # 2Ô∏è‚É£ Debug environment
      # -----------------------------
      - name: Debug runner environment
        run: |
          echo "===== DEBUG INFO ====="
          whoami
          pwd
          echo "SERVICE_NAME=${{ vars.SERVICE_NAME }}"
          echo "PROJECT_PATH=${{ vars.PROJECT_PATH }}"
          echo "SERVER_USER=${{ secrets.SERVER_USER }}"
          echo "SERVER_IP=${{ secrets.SERVER_IP }}"
          echo "======================"

      # -----------------------------
      # 3Ô∏è‚É£ Build .NET app
      # -----------------------------
      - name: Build .NET application
        run: |
          set -x  # print each command
          dotnet publish -c Release -o publish

      # -----------------------------
      # 4Ô∏è‚É£ Stop the .NET service
      # -----------------------------
      - name: Stop .NET service
        run: |
          set -x
          sudo systemctl stop ${{ vars.SERVICE_NAME }} || echo "Service might not exist yet"

      # -----------------------------
      # 5Ô∏è‚É£ Upload changed files via rsync
      # -----------------------------
      - name: Upload changed files to server
        run: |
          set -x
          rsync -avz --delete publish/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:${{ vars.PROJECT_PATH }}

      # -----------------------------
      # 6Ô∏è‚É£ Start the .NET service
      # -----------------------------
      - name: Start .NET service
        run: |
          set -x
          sudo systemctl start ${{ vars.SERVICE_NAME }}

      # -----------------------------
      # 7Ô∏è‚É£ Verify service status
      # -----------------------------
      - name: Verify service status
        run: |
          set -x
          STATUS=$(systemctl is-active ${{ vars.SERVICE_NAME }})
          echo "Service status: $STATUS"
          if [ "$STATUS" != "active" ]; then
            echo "‚ùå Service failed to start!"
            exit 1
          fi

      # -----------------------------
      # 8Ô∏è‚É£ Optional: List deployed files
      # -----------------------------
      - name: List deployed files on server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "ls -la ${{ vars.PROJECT_PATH }}"
