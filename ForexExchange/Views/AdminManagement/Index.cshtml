@using ForexExchange.Extensions
@using ForexExchange.Models

<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history"></i>
                    لاگ فعالیت‌های ادمین
                </h5>
                <div>
                    <button id="testNotificationBtn" class="btn btn-light btn-sm">
                        <i class="fas fa-bell"></i>
                        تست اعلان
                    </button>
                    <button id="exportBtn" class="btn btn-success btn-sm">
                        <i class="fas fa-download"></i>
                        صادرات
                    </button>
                </div>
            </div>

            <div class="card-body">
                <!-- Filters -->
                <form method="get" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="adminUserId" class="form-label">کاربر ادمین</label>
                            <select name="adminUserId" id="adminUserId" class="form-select">
                                <option value="">همه کاربران</option>
                                @foreach (var user in ViewBag.AdminUsers ?? new List<ApplicationUser>())
                                {
                                    <option value="@user.Id" selected="@(ViewBag.FilterAdminUserId == user.Id)">
                                        @user.UserName
                                    </option>
                                }
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label for="activityType" class="form-label">نوع فعالیت</label>
                            <select name="activityType" id="activityType" class="form-select">
                                <option value="">همه فعالیت‌ها</option>
                                @foreach (AdminActivityType type in Enum.GetValues(typeof(AdminActivityType)))
                                {
                                    <option value="@type" selected="@(ViewBag.FilterActivityType?.ToString() == type.ToString())">
                                        @type.GetDisplayName()
                                    </option>
                                }
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label for="fromDate" class="form-label">از تاریخ</label>
                            <input type="date" name="fromDate" id="fromDate" class="form-control"
                                   value="@(ViewBag.FilterFromDate?.ToString("yyyy-MM-dd"))">
                        </div>

                        <div class="col-md-2">
                            <label for="toDate" class="form-label">تا تاریخ</label>
                            <input type="date" name="toDate" id="toDate" class="form-control"
                                   value="@(ViewBag.FilterToDate?.ToString("yyyy-MM-dd"))">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i>
                                    جستجو
                                </button>
                                <a href="@Url.Action("Index")" class="btn btn-secondary">
                                    <i class="fas fa-times"></i>
                                    پاک کردن
                                </a>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h6>کل فعالیت‌ها</h6>
                                <h3>@ViewBag.TotalActivities</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h6>معاملهات</h6>
                                <h3>@(ViewBag.ActivityStats?.GetValueOrDefault("OrderCreated", 0) ?? 0)</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h6>نرخ ارز</h6>
                                <h3>@(ViewBag.ActivityStats?.GetValueOrDefault("ExchangeRateUpdated", 0) ?? 0)</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h6>ورود ناموفق</h6>
                                <h3>@(ViewBag.ActivityStats?.GetValueOrDefault("FailedLogin", 0) ?? 0)</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activities Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>زمان</th>
                                <th>کاربر</th>
                                <th>نوع فعالیت</th>
                                <th>توضیحات</th>
                                <th>وضعیت</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (ViewBag.Activities != null && ViewBag.Activities.Any())
                            {
                                foreach (var activity in ViewBag.Activities)
                                {
                                    <tr>
                                        <td>@activity.Timestamp.ToString("yyyy/MM/dd HH:mm")</td>
                                        <td>@activity.AdminUsername</td>
                                        <td>
                                            <span class="badge bg-@GetActivityBadgeClass(activity.ActivityType)">
                                                @activity.ActivityType.GetDisplayName()
                                            </span>
                                        </td>
                                        <td>
                                            <div class="text-truncate" style="max-width: 300px;" title="@activity.Description">
                                                @activity.Description
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-@(activity.IsSuccess ? "success" : "danger")">
                                                @(activity.IsSuccess ? "موفق" : "ناموفق")
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" onclick="showActivityDetails(@activity.Id)">
                                                <i class="fas fa-eye"></i>
                                                جزئیات
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        <i class="fas fa-inbox fa-2x mb-2"></i>
                                        <br>
                                        فعالیتی یافت نشد
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                @if (ViewBag.TotalPages > 1)
                {
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center">
                            @for (int i = 1; i <= ViewBag.TotalPages; i++)
                            {
                                <li class="page-item @(i == ViewBag.Page ? "active" : "")">
                                    <a class="page-link" href="@Url.Action("Index", new {
                                        adminUserId = ViewBag.FilterAdminUserId,
                                        activityType = ViewBag.FilterActivityType,
                                        fromDate = ViewBag.FilterFromDate?.ToString("yyyy-MM-dd"),
                                        toDate = ViewBag.FilterToDate?.ToString("yyyy-MM-dd"),
                                        page = i,
                                        pageSize = ViewBag.PageSize
                                    })">@i</a>
                                </li>
                            }
                        </ul>
                    </nav>
                }
            </div>
        </div>
    </div>
</div>

<!-- Activity Details Modal -->
<div class="modal fade" id="activityDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">جزئیات فعالیت</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="activityDetailsContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Test notification button
        document.getElementById('testNotificationBtn').addEventListener('click', function() {
            if (window.adminNotificationManager) {
                window.adminNotificationManager.sendTestNotification();
            } else {
                Swal.fire('خطا', 'سیستم اعلان فعال نیست', 'error');
            }
        });

        // Export button
        document.getElementById('exportBtn').addEventListener('click', function() {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '@Url.Action("ExportActivities")';

            // Add form fields
            const fields = ['adminUserId', 'activityType', 'fromDate', 'toDate'];
            fields.forEach(field => {
                const input = document.getElementById(field);
                if (input && input.value) {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = field;
                    hiddenInput.value = input.value;
                    form.appendChild(hiddenInput);
                }
            });

            // Add CSRF token
            const csrfToken = document.querySelector('input[name="__RequestVerificationToken"]');
            if (csrfToken) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = csrfToken.value;
                form.appendChild(tokenInput);
            }

            document.body.appendChild(form);
            form.submit();
        });

        // Show activity details
        function showActivityDetails(activityId) {
            fetch('@Url.Action("GetActivityDetails")/' + activityId)
                .then(response => response.json())
                .then(data => {
                    const content = document.getElementById('activityDetailsContent');
                    content.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>شناسه:</strong> ${data.id}</p>
                                <p><strong>کاربر:</strong> ${data.adminUsername}</p>
                                <p><strong>نوع فعالیت:</strong> ${data.activityType}</p>
                                <p><strong>زمان:</strong> ${new Date(data.timestamp).toLocaleString('fa-IR')}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>وضعیت:</strong> <span class="badge bg-${data.isSuccess ? 'success' : 'danger'}">${data.isSuccess ? 'موفق' : 'ناموفق'}</span></p>
                                <p><strong>آدرس IP:</strong> ${data.ipAddress || 'نامشخص'}</p>
                                <p><strong>مرورگر:</strong> ${data.userAgent || 'نامشخص'}</p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <strong>توضیحات:</strong>
                            <p>${data.description}</p>
                        </div>
                        ${data.details ? `
                        <div class="mt-3">
                            <strong>جزئیات:</strong>
                            <pre class="bg-light p-2 rounded">${JSON.stringify(JSON.parse(data.details), null, 2)}</pre>
                        </div>
                        ` : ''}
                    `;

                    new bootstrap.Modal(document.getElementById('activityDetailsModal')).show();
                })
                .catch(error => {
                    console.error('Error loading activity details:', error);
                    Swal.fire('خطا', 'خطا در بارگذاری جزئیات فعالیت', 'error');
                });
        }

        // Helper function for activity badge classes
        function GetActivityBadgeClass(activityType) {
            switch (activityType) {
                case 'OrderCreated':
                case 'OrderUpdated':
                    return 'primary';
                case 'ExchangeRateUpdated':
                    return 'info';
                case 'Login':
                    return 'success';
                case 'FailedLogin':
                case 'OrderCancelled':
                    return 'danger';
                case 'DataExport':
                    return 'secondary';
                default:
                    return 'secondary';
            }
        }
    </script>
}

@functions {
    public static string GetActivityBadgeClass(AdminActivityType activityType)
    {
        return activityType switch
        {
            AdminActivityType.OrderCreated => "primary",
            AdminActivityType.OrderUpdated => "primary",
            AdminActivityType.ExchangeRateUpdated => "info",
            AdminActivityType.Login => "success",
            AdminActivityType.FailedLogin => "danger",
            AdminActivityType.OrderCancelled => "danger",
            AdminActivityType.DataExport => "secondary",
            _ => "secondary"
        };
    }
}
