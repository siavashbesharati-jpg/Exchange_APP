@model ForexExchange.Models.Customer
@using ForexExchange.Extensions

@{
    ViewData["Title"] = "پروفایل مشتری";
    var stats = ViewBag.CustomerStats as ForexExchange.Models.CustomerProfileStats;
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <a href="@Url.Action("Index", "Customers")" class="btn btn-outline-secondary me-3">
                <i class="fas fa-arrow-right me-2"></i>
                بازگشت به لیست
            </a>
            <h2 class="mb-0">
                <i class="fas fa-user-circle text-primary me-2"></i>
                پروفایل مشتری - @Model.FullName
            </h2>
        </div>
        <div class="d-flex gap-2">
            @if (Model.IsActive)
            {
                <span class="badge bg-success fs-6">
                    <i class="fas fa-check-circle me-1"></i>
                    فعال
                </span>
            }
            else
            {
                <span class="badge bg-danger fs-6">
                    <i class="fas fa-times-circle me-1"></i>
                    غیرفعال
                </span>
            }
        </div>
    </div>

    <div class="row g-4">
        <!-- Personal Information Card -->
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user text-primary me-2"></i>
                        اطلاعات شخصی
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <td class="fw-medium text-muted" style="width: 30%;">
                                        <i class="fas fa-id-card me-2"></i>
                                        نام کامل:
                                    </td>
                                    <td>@Model.FullName</td>
                                </tr>
                                <tr>
                                    <td class="fw-medium text-muted">
                                        <i class="fas fa-phone me-2"></i>
                                        شماره تلفن:
                                    </td>
                                    <td dir="ltr">
                                        <a href="tel:@Model.PhoneNumber" class="text-decoration-none">
                                            @Model.PhoneNumber
                                        </a>
                                    </td>
                                </tr>
                                @if (!string.IsNullOrEmpty(Model.Email))
                                {
                                    <tr>
                                        <td class="fw-medium text-muted">
                                            <i class="fas fa-envelope me-2"></i>
                                            ایمیل:
                                        </td>
                                        <td dir="ltr">@Model.Email</td>
                                    </tr>
                                }
                                <tr>
                                    <td class="fw-medium text-muted">
                                        <i class="fas fa-fingerprint me-2"></i>
                                        کد ملی:
                                    </td>
                                    <td dir="ltr">@Model.NationalId</td>
                                </tr>
                                <tr>
                                    <td class="fw-medium text-muted">
                                        <i class="fas fa-calendar-plus me-2"></i>
                                        تاریخ عضویت:
                                    </td>
                                    <td>@Model.CreatedAt.ToString("yyyy/MM/dd")</td>
                                </tr>
                                @if (stats != null)
                                {
                                    <tr>
                                        <td class="fw-medium text-muted">
                                            <i class="fas fa-clock me-2"></i>
                                            مدت عضویت:
                                        </td>
                                        <td>@stats.RegistrationDays روز</td>
                                    </tr>
                                }
                                @if (!string.IsNullOrEmpty(Model.Address))
                                {
                                    <tr>
                                        <td class="fw-medium text-muted">
                                            <i class="fas fa-map-marker-alt me-2"></i>
                                            آدرس:
                                        </td>
                                        <td>@Model.Address</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Summary Card -->
        <div class="col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar text-success me-2"></i>
                        خلاصه فعالیت
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 text-center">
                        <div class="col-4">
                            <div class="p-3 bg-primary bg-opacity-10 rounded">
                                <i class="fas fa-exchange-alt text-primary fs-3 mb-2"></i>
                                <h4 class="text-primary mb-1">@Model.Orders.Count</h4>
                                <small class="text-muted">کل معاملات</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 bg-success bg-opacity-10 rounded">
                                @{
                                    var debtCreditInfo = ViewBag.CustomerDebtCredit as ForexExchange.Models.CustomerDebtCredit;
                                    var balanceCount = debtCreditInfo?.CurrencyBalances?.Count(b => b.Balance != 0) ?? 0;
                                }
                                <i class="fas fa-coins text-success fs-3 mb-2"></i>
                                <h4 class="text-success mb-1">@balanceCount</h4>
                                <small class="text-muted">ارزهای فعال</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 bg-info bg-opacity-10 rounded">
                                @{
                                    var lastOrder = Model.Orders.OrderByDescending(o => o.CreatedAt).FirstOrDefault();
                                    var daysSinceLastOrder = lastOrder != null ? (DateTime.Now - lastOrder.CreatedAt).Days : 0;
                                }
                                <i class="fas fa-calendar-check text-info fs-3 mb-2"></i>
                                <h4 class="text-info mb-1">@(lastOrder != null ? daysSinceLastOrder.ToString() : "---")</h4>
                                <small class="text-muted">روز از آخرین معامله</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trading Information Section -->
    <div class="row g-4 mt-2">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line text-warning me-2"></i>
                        اطلاعات معاملات و موجودی
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Tab Navigation -->
                    <ul class="nav nav-tabs mb-3" id="profileTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                                <i class="fas fa-handshake me-2"></i>
                                معاملات (@Model.Orders.Count)
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="balances-tab" data-bs-toggle="tab" data-bs-target="#balances" type="button" role="tab">
                                <i class="fas fa-balance-scale me-2"></i>
                                موجودی ارزها
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="profileTabsContent">
                        <!-- Orders Tab -->
                        <div class="tab-pane fade show active" id="orders" role="tabpanel">
                            @if (Model.Orders.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>شماره</th>
                                                <th>پرداخت</th>
                                                <th>دریافت</th>
                                                <th>نرخ</th>
                                                <th>تاریخ</th>
                                                <th>عملیات</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var order in Model.Orders.OrderByDescending(o => o.CreatedAt).Take(10))
                                            {
                                                <tr>
                                                    <td>
                                                        <span class="badge bg-primary">#@order.Id</span>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex flex-column">
                                                            <span class="fw-bold">@(order.FromCurrency?.Code == "IRR" ? order.FromAmount.ToString("N0") : order.FromAmount.ToString("N2"))</span>
                                                            <small class="text-muted">@order.FromCurrency?.Code</small>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex flex-column">
                                                            <span class="fw-bold">@((order.FromAmount * order.Rate).ToString(order.ToCurrency?.Code == "IRR" ? "N0" : "N2"))</span>
                                                            <small class="text-muted">@order.ToCurrency?.Code</small>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="text-info fw-bold">@(order.ToCurrency?.Code == "IRR" ? order.Rate.ToString("N0") : order.Rate.ToString("N2"))</span>
                                                    </td>
                                                    <td>
                                                        <span class="text-muted">@order.CreatedAt.ToString("yyyy/MM/dd")</span>
                                                    </td>
                                                    <td>
                                                        <a asp-controller="Orders" asp-action="Details" asp-route-id="@order.Id" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                
                                @if (Model.Orders.Count > 10)
                                {
                                    <div class="text-center mt-3">
                                        <a asp-controller="Orders" asp-action="Index" asp-route-customerId="@Model.Id" class="btn btn-outline-primary">
                                            <i class="fas fa-list me-2"></i>
                                            مشاهده همه معاملات (@Model.Orders.Count)
                                        </a>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-center py-5">
                                    <i class="fas fa-chart-line text-muted mb-3" style="font-size: 3rem;"></i>
                                    <h5 class="text-muted">هیچ معامله‌ای ثبت نشده</h5>
                                    <p class="text-muted">تاکنون هیچ معامله‌ای انجام نشده است</p>
                                </div>
                            }
                        </div>

                        <!-- Balances Tab -->
                        <div class="tab-pane fade" id="balances" role="tabpanel">
                            @if (debtCreditInfo != null && debtCreditInfo.CurrencyBalances.Any())
                            {
                                <div class="row g-3">
                                    @foreach (var balance in debtCreditInfo.CurrencyBalances.Where(b => b.Balance != 0))
                                    {
                                        <div class="col-md-6 col-lg-4">
                                            <div class="card @(balance.Balance >= 0 ? "border-success" : "border-danger")">
                                                <div class="card-body text-center">
                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                        <h6 class="card-title mb-0">@balance.CurrencyName</h6>
                                                        @if (balance.Balance >= 0)
                                                        {
                                                            <i class="fas fa-arrow-up text-success"></i>
                                                        }
                                                        else
                                                        {
                                                            <i class="fas fa-arrow-down text-danger"></i>
                                                        }
                                                    </div>
                                                    <div class="mb-2">
                                                        <span class="badge bg-secondary">@balance.CurrencyCode</span>
                                                    </div>
                                                    <h4 class="@(balance.Balance >= 0 ? "text-success" : "text-danger")" dir="ltr">
                                                        @(balance.CurrencyCode == "IRR" ? balance.Balance.ToString("N0") : balance.Balance.ToString("N2"))
                                                    </h4>
                                                    <small class="@(balance.Balance >= 0 ? "text-success" : "text-danger")">
                                                        @(balance.Balance >= 0 ? "بستانکار" : "بدهکار")
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>

                                <!-- Recent Financial Documents -->
                                <div class="mt-4">
                                    <h6 class="border-bottom pb-2 mb-3">
                                        <i class="fas fa-file-invoice-dollar text-primary me-2"></i>
                                        آخرین اسناد مالی
                                    </h6>
                                    @{
                                        var allDocs = ViewBag.AllAccountingDocuments as List<AccountingDocument> ?? new List<AccountingDocument>();
                                        var recentDocs = allDocs.Where(d => d.CreatedAt > DateTime.Now.AddDays(-30))
                                                               .OrderByDescending(d => d.CreatedAt)
                                                               .Take(5)
                                                               .ToList();
                                    }
                                    @if (recentDocs.Any())
                                    {
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>نوع</th>
                                                        <th>مبلغ</th>
                                                        <th>تاریخ</th>
                                                        <th>وضعیت</th>
                                                        <th>عملیات</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var doc in recentDocs)
                                                    {
                                                        <tr>
                                                            <td>
                                                                @if (doc.PayerType == ForexExchange.Models.PayerType.System)
                                                                {
                                                                    <span class="badge bg-success">دریافت</span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="badge bg-danger">پرداخت</span>
                                                                }
                                                            </td>
                                                            <td dir="ltr">
                                                                <span class="fw-bold">@(doc.CurrencyCode == "IRR" ? doc.Amount.ToString("N0") : doc.Amount.ToString("N2"))</span>
                                                                <small class="text-muted">@doc.CurrencyCode</small>
                                                            </td>
                                                            <td>@doc.CreatedAt.ToString("yy/MM/dd")</td>
                                                            <td>
                                                                @if (doc.IsVerified)
                                                                {
                                                                    <span class="badge bg-success">تأیید شده</span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="badge bg-warning">در انتظار</span>
                                                                }
                                                            </td>
                                                            <td>
                                                                <a asp-controller="AccountingDocuments" asp-action="Details" asp-route-id="@doc.Id" class="btn btn-sm btn-outline-primary">
                                                                    <i class="fas fa-eye"></i>
                                                                </a>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="text-center py-3">
                                            <i class="fas fa-file-invoice text-muted mb-2" style="font-size: 2rem;"></i>
                                            <p class="text-muted mb-0">هیچ سند مالی در ۳۰ روز گذشته یافت نشد</p>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5">
                                    <i class="fas fa-balance-scale text-muted mb-3" style="font-size: 3rem;"></i>
                                    <h5 class="text-muted">اطلاعات مالی موجود نیست</h5>
                                    <p class="text-muted">این مشتری هنوز هیچ تراکنش مالی ندارد</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons Section -->
    @if (User?.Identity?.IsAuthenticated == true && User?.IsInRole("Admin") == true)
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-tools text-danger me-2"></i>
                            عملیات مدیریت
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning w-100">
                                    <i class="fas fa-edit me-2"></i>
                                    ویرایش اطلاعات
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a asp-action="ComprehensiveStatement" asp-route-id="@Model.Id" class="btn btn-primary w-100">
                                    <i class="fas fa-file-invoice me-2"></i>
                                    صورت حساب کامل
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a asp-action="TransactionsStatement" asp-route-id="@Model.Id" class="btn btn-success w-100">
                                    <i class="fas fa-exchange-alt me-2"></i>
                                    صورت حساب معاملات
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a asp-action="ShareableLinks" asp-route-id="@Model.Id" class="btn btn-info w-100">
                                    <i class="fas fa-link me-2"></i>
                                    مدیریت لینک ها
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-file-alt text-primary me-2"></i>
                            گزارش‌ها
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <a asp-action="ComprehensiveStatement" asp-route-id="@Model.Id" class="btn btn-primary w-100">
                                    <i class="fas fa-file-invoice me-2"></i>
                                    صورت حساب کامل
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a asp-action="TransactionsStatement" asp-route-id="@Model.Id" class="btn btn-success w-100">
                                    <i class="fas fa-exchange-alt me-2"></i>
                                    صورت حساب معاملات
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

