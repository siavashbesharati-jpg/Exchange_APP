@model List<ForexExchange.Models.ShareableLink>
@{
    ViewData["Title"] = "مدیریت لینک‌های اشتراکی";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
                <h2><i class="fas fa-link text-primary me-2"></i>مدیریت لینک‌های اشتراکی</h2>
                <a href="@Url.Action("Management", "Home")" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-right me-1"></i>بازگشت
                </a>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ShareableUrl"] != null)
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <h6 class="alert-heading"><i class="fas fa-link me-2"></i>لینک ایجاد شده:</h6>
            <div class="input-group">
                <input type="text" class="form-control" id="shareableUrl" value="@TempData["ShareableUrl"]" readonly>
                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard()">
                    <i class="fas fa-copy me-1"></i>کپی
                </button>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Create New Link Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-plus-circle me-2"></i>
                        ایجاد لینک اشتراکی جدید
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="GenerateShareableLink">
                        @Html.AntiForgeryToken()
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="customerId" class="form-label">مشتری <span class="text-danger">*</span></label>
                                <select class="form-select" id="customerId" name="customerId" required>
                                    <option value="">انتخاب مشتری</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="linkType" class="form-label">نوع لینک <span class="text-danger">*</span></label>
                                <select class="form-select" id="linkType" name="linkType" required>
                                    <option value="@ForexExchange.Models.ShareableLinkType.CustomerReport">گزارش مشتری</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="expirationDays" class="form-label">اعتبار (روز)</label>
                                <input type="number" class="form-control" id="expirationDays" name="expirationDays" value="7" min="1" max="365">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-plus me-1"></i>ایجاد لینک
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Links List -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        لینک‌های موجود (@Model.Count)
                    </h5>
                </div>
                <div class="card-body p-0">
                    @if (Model.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>مشتری</th>
                                        <th>نوع لینک</th>
                                        <th>تاریخ ایجاد</th>
                                        <th>تاریخ انقضا</th>
                                        <th>وضعیت</th>
                                        <th>تعداد دسترسی</th>
                                        <th>آخرین دسترسی</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var link in Model)
                                    {
                                        <tr class="@(link.IsValid ? "" : "table-secondary")">
                                            <td>
                                                <strong>@link.Customer?.FullName</strong>
                                                <br>
                                                <small class="text-muted">ID: @link.CustomerId</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">
                                                    @(link.LinkType == ForexExchange.Models.ShareableLinkType.CustomerReport ? "گزارش مشتری" : link.LinkType.ToString())
                                                </span>
                                            </td>
                                            <td>
                                                <small>@link.CreatedAt.ToString("yyyy/MM/dd HH:mm")</small>
                                                @if (!string.IsNullOrEmpty(link.CreatedBy))
                                                {
                                                    <br><small class="text-muted">@link.CreatedBy</small>
                                                }
                                            </td>
                                            <td>
                                                <small class="@(link.ExpiresAt < DateTime.Now ? "text-danger" : "text-success")">
                                                    @link.ExpiresAt.ToString("yyyy/MM/dd HH:mm")
                                                </small>
                                            </td>
                                            <td>
                                                @if (link.IsValid)
                                                {
                                                    <span class="badge bg-success">فعال</span>
                                                }
                                                else if (!link.IsActive)
                                                {
                                                    <span class="badge bg-danger">غیرفعال</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning">منقضی</span>
                                                }
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">@link.AccessCount</span>
                                            </td>
                                            <td>
                                                @if (link.LastAccessedAt.HasValue)
                                                {
                                                    <small>@link.LastAccessedAt.Value.ToString("yyyy/MM/dd HH:mm")</small>
                                                }
                                                else
                                                {
                                                    <small class="text-muted">هرگز</small>
                                                }
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    @if (link.IsValid)
                                                    {
                                                        <button type="button" class="btn btn-sm btn-outline-primary copy-link-btn" 
                                                                data-url="@link.GetShareableUrl($"{Context.Request.Scheme}://{Context.Request.Host}")">
                                                            <i class="fas fa-copy"></i>
                                                        </button>
                                                        <a href="@link.GetShareableUrl($"{Context.Request.Scheme}://{Context.Request.Host}")" 
                                                           target="_blank" class="btn btn-sm btn-outline-success">
                                                            <i class="fas fa-external-link-alt"></i>
                                                        </a>
                                                        <form method="post" asp-action="DeactivateShareableLink" style="display: inline;">
                                                            @Html.AntiForgeryToken()
                                                            <input type="hidden" name="linkId" value="@link.Id" />
                                                            <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                                    onclick="return confirm('آیا از غیرفعال کردن این لینک اطمینان دارید؟')">
                                                                <i class="fas fa-ban"></i>
                                                            </button>
                                                        </form>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">غیرفعال</span>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-link fa-3x mb-3"></i>
                            <h5>هیچ لینک اشتراکی یافت نشد</h5>
                            <p>برای ایجاد اولین لینک اشتراکی از فرم بالا استفاده کنید.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadCustomers();
        setupCopyLinkButtons();
    });

    function loadCustomers() {
        fetch('@Url.Action("GetCustomers", "Home")')
            .then(response => response.json())
            .then(customers => {
                const select = document.getElementById('customerId');
                select.innerHTML = '<option value="">انتخاب مشتری</option>';
                
                customers.forEach(customer => {
                    select.innerHTML += `<option value="${customer.id}">${customer.fullName}</option>`;
                });
            })
            .catch(error => {
                console.error('Error loading customers:', error);
            });
    }

    function setupCopyLinkButtons() {
        // Add event listeners to all copy link buttons
        document.querySelectorAll('.copy-link-btn').forEach(button => {
            button.addEventListener('click', function() {
                const url = this.getAttribute('data-url');
                copyLinkToClipboard(url, this);
            });
        });
    }

    function copyToClipboard() {
        const urlInput = document.getElementById('shareableUrl');
        urlInput.select();
        urlInput.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(urlInput.value);
        
        // Show success feedback
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check me-1"></i>کپی شد!';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    }

    function copyLinkToClipboard(url, buttonElement) {
        navigator.clipboard.writeText(url).then(() => {
            // Show success feedback
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i class="fas fa-check"></i>';
            buttonElement.classList.remove('btn-outline-primary');
            buttonElement.classList.add('btn-success');
            
            setTimeout(() => {
                buttonElement.innerHTML = originalText;
                buttonElement.classList.remove('btn-success');
                buttonElement.classList.add('btn-outline-primary');
            }, 2000);
        }).catch(err => {
            console.error('Error copying to clipboard:', err);
            alert('خطا در کپی کردن لینک');
        });
    }
</script>

<style>
    .card {
        border-radius: 10px;
    }
    
    .btn-group .btn {
        border-radius: 0;
    }
    
    .btn-group .btn:first-child {
        border-top-left-radius: 5px;
        border-bottom-left-radius: 5px;
    }
    
    .btn-group .btn:last-child {
        border-top-right-radius: 5px;
        border-bottom-right-radius: 5px;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
    }
</style>