@model ForexExchange.Models.Order

@{
    ViewData["Title"] = "ثبت معامله جدید";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">ثبت معامله جدید</h4>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post">
                        @Html.AntiForgeryToken()
                        @if (!ViewData.ModelState.IsValid && ViewData.ModelState.Values.Any(v => v.Errors.Count > 0))
                        {
                            <div class="alert alert-danger mt-2" id="validationSummaryBox">
                                <ul class="mb-0">
                                    @foreach (var state in ViewData.ModelState.Values)
                                    {
                                        foreach (var error in state.Errors)
                                        {
                                            var msg = error.ErrorMessage;
                                            // Localize known messages
                                            if (msg == "The CustomerId field is required.") msg = "انتخاب مشتری الزامی است.";
                                            if (msg == "The FromCurrencyId field is required.") msg = "انتخاب ارز مبدأ الزامی است.";
                                            if (msg == "The ToCurrencyId field is required.") msg = "انتخاب ارز مقصد الزامی است.";
                                            if (msg == "The Amount field is required.") msg = "مقدار معامله الزامی است.";
                                            <li>@msg</li>
                                        }
                                    }
                                    }
                                </ul>
                            </div>
                        }
                        <div class="alert alert-info mt-2" id="currencyPairMsgBox" style="display: none;"></div>

                        <div class="row mb-3">
                            <!-- Currency Pool Information -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="alert alert-warning" id="currencyPoolInfo" style="display: none;"
                                        dir=ltr>
                                        <h6>موجودی صندوق ارزها:</h6>
                                        <p id="currencyPoolText"></p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="CustomerId" class="form-label">انتخاب مشتری</label>
                                <select asp-for="CustomerId" asp-items="ViewBag.Customers" class="form-select"
                                    id="customerSelect" required>
                                    <option value="">یک مشتری انتخاب کنید</option>
                                </select>
                                <span asp-validation-for="CustomerId" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="CreatedAt" class="form-label">تاریخ و زمان معامله</label>
                                <input asp-for="CreatedAt" type="datetime-local" class="form-control"
                                    id="createdAtInput" />
                                <span asp-validation-for="CreatedAt" class="text-danger"></span>
                                <div class="form-text">تاریخ و زمان ثبت معامله (پیش‌فرض: زمان فعلی)</div>
                            </div>




                            <!-- Removed OrderType dropdown -->
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label asp-for="FromCurrencyId" class="form-label"> دریافت می کنیم </label>
                                <select asp-for="FromCurrencyId" asp-items="ViewBag.FromCurrencies" class="form-select"
                                    id="fromCurrencySelect" required>
                                    <option value="">انتخاب کنید</option>
                                </select>
                                <span asp-validation-for="FromCurrencyId" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="ToCurrencyId" class="form-label"> پرداخت می کنیم </label>
                                <select asp-for="ToCurrencyId" asp-items="ViewBag.ToCurrencies" class="form-select"
                                    id="toCurrencySelect" required>
                                    <option value="">انتخاب کنید</option>
                                </select>
                                <span asp-validation-for="ToCurrencyId" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">نرخ ارز</label>
                                <input type="number" id="calcRateInput" class="form-control" step="any"
                                    placeholder="نرخ ارز را وارد کنید">
                            </div>

                            <div class="col-md-4" style="display: none;">
                                <label asp-for="FromAmount" class="form-label">مقدار (ارز دریافتی)</label>
                                <input asp-for="FromAmount" type="number" class="form-control" step="0.01"
                                    id="amountInput" required />
                                <span asp-validation-for="FromAmount" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Amount Input Row -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label"> <span id="calcFromAmountLabel">---</span></label>
                                <input type="number" id="calcFromAmountInput" class="form-control" step="any"
                                    placeholder="مقدار">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"> <span id="calcToAmountLabel">---</span></label>
                                <input type="number" id="calcToAmountInput" class="form-control" step="any"
                                    placeholder="مقدار">
                            </div>
                        </div>

                        <!-- Hidden elements for JavaScript reference -->
                        <div style="display: none;">
                            <span id="calcRateFromCurrency">---</span>
                            <span id="calcRateLabel">---</span>
                            <span id="calcRateToCurrency">IRR</span>
                            <span id="calcFromCurrencyCode">---</span>
                            <span id="calcFromCurrencyName">انتخاب نشده</span>
                            <span id="calcToCurrencyCode">---</span>
                            <span id="calcToCurrencyName">انتخاب نشده</span>
                            <!-- Hidden inputs for main form compatibility -->
                            <input type="number" id="rateInput" step="any">
                            <button type="button" id="loadSuggestedRateBtn">Load Rate</button>
                        </div>

                        <!-- Currency Pair Information (moved below pool info if needed) -->

                        <!-- Calculation Result -->
                        <div class="row mb-3" style="display: none;">
                            <div class="col-12">
                                <div class="alert alert-info" id="calculationResult" style="display: none;">
                                    <h6>محاسبه خودکار:</h6>
                                    <p id="calculationText" dir=ltr></p>
                                </div>
                            </div>
                        </div>



                        <div class="mb-3">
                            <label asp-for="Notes" class="form-label">توضیحات (اختیاری)</label>
                            <textarea asp-for="Notes" class="form-control" rows="3"
                                placeholder="توضیحات اضافی در مورد معامله..."></textarea>
                            <span asp-validation-for="Notes" class="text-danger"></span>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-action="Index" class="btn btn-secondary">بازگشت به لیست</a>
                            <button type="submit" class="btn btn-primary">ثبت معامله</button>
                        </div>

                        <!-- Hidden fields for calculated values -->
                        <input type="hidden" asp-for="ToAmount" id="hiddenTotalAmount" value="0" />
                        <input type="hidden" asp-for="Rate" id="hiddenRate" value="0" />
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>



@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <!-- Include Currency Formatter -->
    <script src="~/js/currency-formatter.js"></script>

    <script>
        let currentRate = null;
        // Currency pool data loaded from server-side ViewBag (dictionary: code => balance)
        let currencyPools = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.PoolData ?? new Dictionary<string, decimal>()));

        // Calculator functionality - variables for inline calculator
        let calcFromCurrencyId = null;
        let calcToCurrencyId = null;
        let calcFromCurrencyCode = null;
        let calcToCurrencyCode = null;

        function initializeCalculator() {
            // Get current selections from main form using jQuery
            const fromSelect = $('#fromCurrencySelect');
            const toSelect = $('#toCurrencySelect');

            // Check if both currencies are selected in main form
            if (!fromSelect.val() || !toSelect.val()) {
                alert('لطفا ابتدا ارزهای مبدا و مقصد را انتخاب کنید');
                return;
            }

            // Get currency codes and names from main form using Select2 data
            const fromData = fromSelect.select2('data')[0];
            const toData = toSelect.select2('data')[0];

            // Extract code from text (format: "CODE - Name")
            const fromCode = fromData.text.split(' - ')[0].trim(); // What user pays
            const toCode = toData.text.split(' - ')[0].trim(); // What user gets
            const fromName = fromData.text.split(' - ')[1] ? fromData.text.split(' - ')[1].trim() : fromCode;
            const toName = toData.text.split(' - ')[1] ? toData.text.split(' - ')[1].trim() : toCode;

            // Store for calculations
            calcFromCurrencyCode = fromCode; // What user pays (IRR)
            calcToCurrencyCode = toCode;     // What user gets (USD)

            // Update calculator display elements
            document.getElementById('calcFromCurrencyDisplay').textContent = fromCode;
            document.getElementById('calcToCurrencyDisplay').textContent = toCode;
            document.getElementById('calcFromCurrencyName').textContent = fromName;
            document.getElementById('calcToCurrencyName').textContent = toName;
            document.getElementById('fromCurrencyLabel').textContent = fromCode;
            document.getElementById('toCurrencyLabel').textContent = toCode;

            // Always display rate as "1 Non-IRR = X IRR" format
            const nonIrrCode = fromCode.toUpperCase() === 'IRR' ? toCode : fromCode;
            const irrCode = 'IRR';
            document.getElementById('calcToCurrencyInRate').textContent = nonIrrCode;
            document.getElementById('calcFromCurrencyInRate').textContent = irrCode;

            // Get current values from main form
            const currentAmount = parseFloat(document.getElementById('amountInput').value) || '';
            const currentRate = parseFloat(document.getElementById('rateInput').value) || '';

            // Pre-fill calculator with main form values
            if (currentAmount) {
                document.getElementById('calcFromAmount').value = currentAmount; // Amount goes to "From" currency
            }

            if (currentRate && currentRate > 0) {
                // Always display rate as "1 Non-IRR = X IRR"
                let displayRate;
                if (fromCode.toUpperCase() === 'IRR') {
                    // FROM is IRR, TO is foreign currency
                    // Main form rate: how much IRR per foreign currency unit
                    // Display rate should be: 1 foreign currency = X IRR
                    displayRate = 1 / currentRate;
                } else {
                    // FROM is foreign currency, TO is IRR
                    // Main form rate: how much foreign currency per IRR unit
                    // Display rate should be: 1 foreign currency = X IRR
                    displayRate = currentRate;
                }

                // Apply proper precision based on currencies involved
                if (fromCode.toUpperCase() === 'IRR' || toCode.toUpperCase() === 'IRR') {
                    // If IRR is involved, round to whole numbers
                    displayRate = Math.round(displayRate);
                } else {
                    // If both currencies are non-IRR, preserve 2 decimal places
                    displayRate = Math.round(displayRate * 100) / 100;
                }

                document.getElementById('calcRate').value = displayRate;
            }

            // Show sync status
            document.getElementById('syncStatus').style.display = 'block';

            // Calculate initial result if both values are present
            if (currentAmount && currentRate) {
                calculateToFromAmount(); // Calculate TO amount from FROM amount
            }
        }

        // Calculate FROM amount based on TO amount and rate
        function calculateFromToAmount() {
            const toAmount = parseFloat(document.getElementById('calcToAmount').value);
            const rate = parseFloat(document.getElementById('calcRate').value); // Rate is always "1 Non-IRR = X IRR"

            if (toAmount && rate && rate > 0) {
                let fromAmount;

                if (calcFromCurrencyCode.toUpperCase() === 'IRR') {
                    // FROM is IRR, TO is foreign currency
                    // rate = 1 foreign currency = X IRR
                    // fromAmount (IRR) = toAmount (foreign) * rate
                    fromAmount = toAmount * rate;
                    fromAmount = Math.round(fromAmount); // Round IRR amounts
                } else {
                    // FROM is foreign currency, TO is IRR
                    // rate = 1 foreign currency = X IRR
                    // fromAmount (foreign) = toAmount (IRR) / rate
                    fromAmount = toAmount / rate;
                    fromAmount = Math.round(fromAmount * 1000) / 1000; // Round to 3 decimal places
                }

                // Update from amount input using the universal formatter
                document.getElementById('calcFromAmount').value = fromAmount;

                // Show calculation result
                showCalculationResult(toAmount, fromAmount, rate);

                // Auto-update main form with FROM amount (what user is paying)
                updateMainForm(fromAmount, rate);

                return fromAmount;
            } else {
                document.getElementById('calcResult').style.display = 'none';
                return null;
            }
        }

        // Calculate TO amount based on FROM amount and rate
        function calculateToFromAmount() {
            const fromAmount = parseFloat(document.getElementById('calcFromAmount').value);
            const rate = parseFloat(document.getElementById('calcRate').value); // Rate is always "1 Non-IRR = X IRR"

            if (fromAmount && rate && rate > 0) {
                let toAmount;

                if (calcFromCurrencyCode.toUpperCase() === 'IRR') {
                    // FROM is IRR, TO is foreign currency
                    // rate = 1 foreign currency = X IRR
                    // toAmount (foreign) = fromAmount (IRR) / rate
                    toAmount = fromAmount / rate;
                    toAmount = Math.round(toAmount * 1000) / 1000; // Round to 3 decimal places
                } else {
                    // FROM is foreign currency, TO is IRR
                    // rate = 1 foreign currency = X IRR
                    // toAmount (IRR) = fromAmount (foreign) * rate
                    toAmount = fromAmount * rate;
                    toAmount = Math.round(toAmount); // Round IRR amounts
                }

                // Update to amount input using the universal formatter
                document.getElementById('calcToAmount').value = toAmount;

                // Show calculation result
                showCalculationResult(toAmount, fromAmount, rate);

                // Auto-update main form with FROM amount (what user is paying)
                updateMainForm(fromAmount, rate);

                return toAmount;
            } else {
                document.getElementById('calcResult').style.display = 'none';
                return null;
            }
        }

        // Calculate rate based on both amounts
        function calculateRateFromAmounts() {
            const fromAmount = parseFloat(document.getElementById('calcFromAmount').value);
            const toAmount = parseFloat(document.getElementById('calcToAmount').value);

            if (fromAmount && toAmount && fromAmount > 0 && toAmount > 0) {
                let rate;

                if (calcFromCurrencyCode.toUpperCase() === 'IRR') {
                    // FROM is IRR, TO is foreign currency
                    // rate = 1 foreign currency = X IRR
                    // rate = fromAmount (IRR) / toAmount (foreign)
                    rate = fromAmount / toAmount;
                } else {
                    // FROM is foreign currency, TO is IRR
                    // rate = 1 foreign currency = X IRR
                    // rate = toAmount (IRR) / fromAmount (foreign)
                    rate = toAmount / fromAmount;
                }

                // Apply proper precision based on currencies involved
                if (calcFromCurrencyCode.toUpperCase() === 'IRR' || calcToCurrencyCode.toUpperCase() === 'IRR') {
                    // If IRR is involved, round to whole numbers
                    rate = Math.round(rate);
                } else {
                    // If both currencies are non-IRR, preserve 2 decimal places
                    rate = Math.round(rate * 100) / 100;
                }

                // Update rate input
                document.getElementById('calcRate').value = rate;

                // Show calculation result
                showCalculationResult(toAmount, fromAmount, rate);

                // Auto-update main form with FROM amount (what user is paying)
                updateMainForm(fromAmount, rate);

                return rate;
            } else {
                document.getElementById('calcResult').style.display = 'none';
                return null;
            }
        }

        // Show calculation result display
        function showCalculationResult(toAmount, fromAmount, rate) {
            // Use the universal currency formatter
            const formattedToAmount = formatCurrency(toAmount, calcToCurrencyCode);
            const formattedFromAmount = formatCurrency(fromAmount, calcFromCurrencyCode);
            const formattedRate = formatCurrency(rate, 'IRR'); // Rate is always displayed as IRR format

            const formula = `${formattedToAmount} ${calcToCurrencyCode} × ${formattedRate} = ${formattedFromAmount} ${calcFromCurrencyCode}`;

            // Always display rate as "1 Non-IRR = X IRR"
            const nonIrrCode = calcFromCurrencyCode.toUpperCase() === 'IRR' ? calcToCurrencyCode : calcFromCurrencyCode;
            const details = `نرخ: ۱ ${nonIrrCode} = ${formattedRate} IRR`;

            document.getElementById('calculationFormula').textContent = formula;
            document.getElementById('calculationDetails').textContent = details;
            document.getElementById('calcResult').style.display = 'block';
        }

        // Update main form with calculator values
        function updateMainForm(fromAmount, rate, isFromAmountSource = false) {
            // Put FROM amount back to main form (this represents what user is paying/receiving)
            document.getElementById('amountInput').value = fromAmount;

            // Convert calculator rate back to main form format
            let mainFormRate;
            if (calcFromCurrencyCode.toUpperCase() === 'IRR') {
                // FROM is IRR, TO is foreign currency
                // Calculator rate: 1 foreign = X IRR
                // Main form rate: 1 IRR = Y foreign
                mainFormRate = 1 / rate;
            } else {
                // FROM is foreign currency, TO is IRR
                // Calculator rate: 1 foreign = X IRR
                // Main form rate: 1 foreign = X IRR (same)
                mainFormRate = rate;
            }

            document.getElementById('rateInput').value = mainFormRate;
            document.getElementById('hiddenRate').value = mainFormRate;

            // Trigger calculation update in main form
            updateCalculation();
        }

        // Helper function to update rate input step based on currency
        function updateRateInputStep(fromCurrencyCode = null) {
            // Since we use step="any", we don't need to update the HTML step attribute
            // But we keep this function for potential future use or rounding logic
            return;
        }

        // Helper function to format numbers by removing trailing zeros
        function formatNumber(num, fromCurrencyCode = null) {
            // Use the universal formatter for consistency
            return formatCurrency(num, fromCurrencyCode);
        }

        // Calculate FROM amount based on TO amount and rate
        function calculateFromToAmount() {
            const toAmount = parseFloat(document.getElementById('calcToAmount').value);
            const rate = parseFloat(document.getElementById('calcRate').value); // Rate is always "1 Non-IRR = X IRR"

            if (toAmount && rate && rate > 0) {
                let fromAmount;

                if (calcFromCurrencyCode.toUpperCase() === 'IRR') {
                    // FROM is IRR, TO is foreign currency
                    // rate = 1 foreign currency = X IRR
                    // fromAmount (IRR) = toAmount (foreign) * rate
                    fromAmount = toAmount * rate;
                    fromAmount = Math.round(fromAmount); // Round IRR amounts
                } else {
                    // FROM is foreign currency, TO is IRR
                    // rate = 1 foreign currency = X IRR
                    // fromAmount (foreign) = toAmount (IRR) / rate
                    fromAmount = toAmount / rate;
                    fromAmount = Math.round(fromAmount * 1000) / 1000; // Round to 3 decimal places
                }

                // Update from amount input using the universal formatter
                document.getElementById('calcFromAmount').value = fromAmount;

                // Show calculation result
                showCalculationResult(toAmount, fromAmount, rate);

                // Auto-update main form with FROM amount (what user is paying)
                updateMainForm(fromAmount, rate);

                return fromAmount;
            } else {
                document.getElementById('calcResult').style.display = 'none';
                return null;
            }
        }

        // Calculate TO amount based on FROM amount and rate
        function calculateToFromAmount() {
            const fromAmount = parseFloat(document.getElementById('calcFromAmount').value);
            const rate = parseFloat(document.getElementById('calcRate').value); // Rate is always "1 Non-IRR = X IRR"

            if (fromAmount && rate && rate > 0) {
                let toAmount;

                if (calcFromCurrencyCode.toUpperCase() === 'IRR') {
                    // FROM is IRR, TO is foreign currency
                    // rate = 1 foreign currency = X IRR
                    // toAmount (foreign) = fromAmount (IRR) / rate
                    toAmount = fromAmount / rate;
                    toAmount = Math.round(toAmount * 1000) / 1000; // Round to 3 decimal places
                } else {
                    // FROM is foreign currency, TO is IRR
                    // rate = 1 foreign currency = X IRR
                    // toAmount (IRR) = fromAmount (foreign) * rate
                    toAmount = fromAmount * rate;
                    toAmount = Math.round(toAmount); // Round IRR amounts
                }

                // Update to amount input using the universal formatter
                document.getElementById('calcToAmount').value = toAmount;

                // Show calculation result
                showCalculationResult(toAmount, fromAmount, rate);

                // Auto-update main form with FROM amount (what user is paying)
                updateMainForm(fromAmount, rate);

                return toAmount;
            } else {
                document.getElementById('calcResult').style.display = 'none';
                return null;
            }
        }

        // Calculate rate based on both amounts
        function calculateRateFromAmounts() {
            const fromAmount = parseFloat(document.getElementById('calcFromAmount').value);
            const toAmount = parseFloat(document.getElementById('calcToAmount').value);

            if (fromAmount && toAmount && fromAmount > 0 && toAmount > 0) {
                let rate;

                if (calcFromCurrencyCode.toUpperCase() === 'IRR') {
                    // FROM is IRR, TO is foreign currency
                    // rate = 1 foreign currency = X IRR
                    // rate = fromAmount (IRR) / toAmount (foreign)
                    rate = fromAmount / toAmount;
                } else {
                    // FROM is foreign currency, TO is IRR
                    // rate = 1 foreign currency = X IRR
                    // rate = toAmount (IRR) / fromAmount (foreign)
                    rate = toAmount / fromAmount;
                }
                // Apply proper precision based on currencies involved
                if (calcFromCurrencyCode.toUpperCase() === 'IRR' || calcToCurrencyCode.toUpperCase() === 'IRR') {
                    // If IRR is involved, round to whole numbers
                    rate = Math.round(rate);
                } else {
                    // If both currencies are non-IRR, preserve 2 decimal places
                    rate = Math.round(rate * 100) / 100;
                }

                // Update rate input
                document.getElementById('calcRate').value = rate;

                // Show calculation result
                showCalculationResult(toAmount, fromAmount, rate);

                // Auto-update main form with FROM amount (what user is paying)
                updateMainForm(fromAmount, rate);

                return rate;
            } else {
                document.getElementById('calcResult').style.display = 'none';
                return null;
            }
        }

        // Show calculation result display
        function showCalculationResult(toAmount, fromAmount, rate) {
            // Use the universal currency formatter
            const formattedToAmount = formatCurrency(toAmount, calcToCurrencyCode);
            const formattedFromAmount = formatCurrency(fromAmount, calcFromCurrencyCode);
            const formattedRate = formatCurrency(rate, 'IRR'); // Rate is always displayed as IRR format

            const formula = `${formattedToAmount} ${calcToCurrencyCode} × ${formattedRate} = ${formattedFromAmount} ${calcFromCurrencyCode}`;

            // Always display rate as "1 Non-IRR = X IRR"
            const nonIrrCode = calcFromCurrencyCode.toUpperCase() === 'IRR' ? calcToCurrencyCode : calcFromCurrencyCode;
            const details = `نرخ: ۱ ${nonIrrCode} = ${formattedRate} IRR`;

            document.getElementById('calculationFormula').textContent = formula;
            document.getElementById('calculationDetails').textContent = details;
            document.getElementById('calcResult').style.display = 'block';
        }

        // Update main form with calculator values
        function updateMainForm(fromAmount, rate, isFromAmountSource = false) {
            // Put FROM amount back to main form (this represents what user is paying/receiving)
            document.getElementById('amountInput').value = fromAmount;

            // Convert calculator rate back to main form format
            let mainFormRate;
            if (calcFromCurrencyCode.toUpperCase() === 'IRR') {
                // FROM is IRR, TO is foreign currency
                // Calculator rate: 1 foreign = X IRR
                // Main form rate: 1 IRR = Y foreign
                mainFormRate = 1 / rate;
            } else {
                // FROM is foreign currency, TO is IRR
                // Calculator rate: 1 foreign = X IRR
                // Main form rate: 1 foreign = X IRR (same)
                mainFormRate = rate;
            }

            document.getElementById('rateInput').value = mainFormRate;
            document.getElementById('hiddenRate').value = mainFormRate;

            // Trigger calculation update in main form
            updateCalculation();
        }

        // Helper function to update rate input step based on currency
        function updateRateInputStep(fromCurrencyCode = null) {
            // Since we use step="any", we don't need to update the HTML step attribute
            // But we keep this function for potential future use or rounding logic
            return;
        }




        function showCurrencyPoolInfo(fromCurrencyId, toCurrencyId) {
            // Get currency codes from Select2 data
            const fromSelect = $('#fromCurrencySelect');
            const toSelect = $('#toCurrencySelect');

            let fromCode = null, toCode = null;

            if (fromSelect.val()) {
                const fromData = fromSelect.select2('data')[0];
                fromCode = fromData.text.split(' - ')[0].trim();
            }

            if (toSelect.val()) {
                const toData = toSelect.select2('data')[0];
                toCode = toData.text.split(' - ')[0].trim();
            }

            // Debug logs
            console.log('currencyPools:', currencyPools);
            console.log('fromCode:', fromCode, 'toCode:', toCode);
            console.log('fromPoolValue:', currencyPools[fromCode]);
            console.log('toPoolValue:', currencyPools[toCode]);
            let html = '';
            if (fromCode && currencyPools.hasOwnProperty(fromCode)) {
                const fromVal = currencyPools[fromCode];
                const fromBadge = fromVal < 0 ? 'badge bg-danger' : 'badge bg-success';
                html += `<strong>موجودی ${fromCode}:</strong> <span class="${fromBadge}">${formatCurrency(fromVal, fromCode)}</span>`;
            }
            if (toCode && currencyPools.hasOwnProperty(toCode)) {
                const toVal = currencyPools[toCode];
                const toBadge = toVal < 0 ? 'badge bg-danger' : 'badge bg-success';
                html += `<br><strong>موجودی ${toCode}:</strong> <span class="${toBadge}">${formatCurrency(toVal, toCode)}</span>`;
            }
            if (html) {
                document.getElementById('currencyPoolText').innerHTML = html;
                document.getElementById('currencyPoolInfo').style.display = 'block';
            } else {
                document.getElementById('currencyPoolInfo').style.display = 'none';
            }
        }

        function updateCalculation() {
            var amount = document.getElementById('amountInput').value;
            var rate = document.getElementById('rateInput').value;

            // Get from currency code for formatting
            const fromSelect = document.getElementById('fromCurrencySelect');
            const fromCode = fromSelect.value ? fromSelect.options[fromSelect.selectedIndex].text.split(' - ')[0].trim() : null;

            if (amount && rate && parseFloat(rate) > 0) {
                var total = parseFloat(amount) * parseFloat(rate);

                document.getElementById('calculationText').innerHTML =
                    `${formatCurrency(parseFloat(amount), fromCode)} × ${formatCurrency(parseFloat(rate), fromCode)} = <strong>${formatCurrency(total, 'IRR')}</strong>`;
                document.getElementById('calculationResult').style.display = 'block';

                // Update hidden total amount field
                document.getElementById('hiddenTotalAmount').value = total;
                // Update hidden rate field
                document.getElementById('hiddenRate').value = rate;
            } else {
                document.getElementById('calculationResult').style.display = 'none';
                document.getElementById('hiddenTotalAmount').value = '0';
                document.getElementById('hiddenRate').value = '0';
            }
        }

        // Function to update button states based on currency selection
        function updateButtonStates() {
            let fromCurrency, toCurrency;

            // Try Select2 first, then fallback to regular select
            if (typeof $.fn.select2 !== 'undefined' && $('#fromCurrencySelect').hasClass('select2-hidden-accessible')) {
                fromCurrency = $('#fromCurrencySelect').val();
                toCurrency = $('#toCurrencySelect').val();
            } else {
                fromCurrency = document.getElementById('fromCurrencySelect').value;
                toCurrency = document.getElementById('toCurrencySelect').value;
            }

            const hasValidCurrencies = fromCurrency && toCurrency && fromCurrency !== toCurrency;

            console.log('updateButtonStates - fromCurrency:', fromCurrency, 'toCurrency:', toCurrency, 'hasValidCurrencies:', hasValidCurrencies);

            // Enable/disable buttons based on currency selection
            const loadSuggestedBtn = document.getElementById('loadSuggestedRateBtn');

            if (loadSuggestedBtn) {
                loadSuggestedBtn.disabled = !hasValidCurrencies;
            }

            // Initialize calculator when currencies are selected
            if (hasValidCurrencies) {
                initializeInlineCalculator();
            }
        }

        // Initialize inline calculator with current currency selection
        function initializeInlineCalculator() {
            console.log('=== initializeInlineCalculator called ===');

            // Get current selections from main form
            let fromSelect, toSelect, fromData, toData;

            if (typeof $.fn.select2 !== 'undefined' && $('#fromCurrencySelect').hasClass('select2-hidden-accessible')) {
                fromSelect = $('#fromCurrencySelect');
                toSelect = $('#toCurrencySelect');

                if (fromSelect.val() && toSelect.val()) {
                    fromData = fromSelect.select2('data')[0];
                    toData = toSelect.select2('data')[0];
                }
            } else {
                fromSelect = document.getElementById('fromCurrencySelect');
                toSelect = document.getElementById('toCurrencySelect');

                if (fromSelect.value && toSelect.value) {
                    fromData = { text: fromSelect.options[fromSelect.selectedIndex].text };
                    toData = { text: toSelect.options[toSelect.selectedIndex].text };
                }
            }

            console.log('Currency data:', fromData, toData);

            if (!fromData || !toData) {
                console.log('Missing currency data, aborting initialization');
                return;
            }

            // Extract currency codes and names
            const fromCode = fromData.text.split(' - ')[0].trim();
            const toCode = toData.text.split(' - ')[0].trim();
            const fromName = fromData.text.split(' - ')[1] ? fromData.text.split(' - ')[1].trim() : fromCode;
            const toName = toData.text.split(' - ')[1] ? toData.text.split(' - ')[1].trim() : toCode;

            console.log('Extracted codes:', fromCode, toCode);
            console.log('Extracted names:', fromName, toName);

            // Store for later use
            calcFromCurrencyCode = fromCode;
            calcToCurrencyCode = toCode;

            // Update display elements
            document.getElementById('calcFromCurrencyCode').textContent = fromCode;
            document.getElementById('calcFromCurrencyName').textContent = fromName;
            document.getElementById('calcToCurrencyCode').textContent = toCode;
            document.getElementById('calcToCurrencyName').textContent = toName;

            // Update amount labels
            document.getElementById('calcFromAmountLabel').textContent = fromCode;
            document.getElementById('calcToAmountLabel').textContent = toCode;

            // Update rate display (always show as "1 Non-IRR = X IRR")
            const nonIrrCode = fromCode.toUpperCase() === 'IRR' ? toCode : fromCode;
            document.getElementById('calcRateFromCurrency').textContent = nonIrrCode;
            document.getElementById('calcRateLabel').textContent = 'X';
            document.getElementById('calcRateToCurrency').textContent = 'IRR';

            // Clear previous values
            document.getElementById('calcFromAmountInput').value = '';
            document.getElementById('calcToAmountInput').value = '';
            document.getElementById('calcRateInput').value = '';

            console.log('Cleared calculator inputs');

            // Automatically load and set the rate
            if (typeof $.fn.select2 !== 'undefined' && $('#fromCurrencySelect').hasClass('select2-hidden-accessible')) {
                loadRateForCalculator(fromSelect.val(), toSelect.val());
            } else {
                loadRateForCalculator(fromSelect.value, toSelect.value);
            }
        }

        // Load rate automatically for calculator
        function loadRateForCalculator(fromCurrencyId, toCurrencyId) {
            console.log('=== loadRateForCalculator called ===');
            console.log('Loading rate for fromCurrencyId:', fromCurrencyId, 'toCurrencyId:', toCurrencyId);

            const url = `/Orders/GetExchangeRate?fromCurrencyId=${fromCurrencyId}&toCurrencyId=${toCurrencyId}&orderType=Buy`;
            console.log('Fetching rate from URL:', url);

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('Rate response received:', data);
                    if (data.success && data.rate > 0) {
                        // Get currency codes for rate formatting
                        const fromCode = calcFromCurrencyCode;
                        const toCode = calcToCurrencyCode;

                        console.log('Processing rate for currencies:', fromCode, 'to', toCode);

                        let displayRate;
                        if (fromCode.toUpperCase() === 'IRR') {
                            displayRate = 1 / data.rate;
                        } else {
                            displayRate = data.rate;
                        }

                        // Apply proper precision based on currencies involved
                        if (fromCode.toUpperCase() === 'IRR' || toCode.toUpperCase() === 'IRR') {
                            // If IRR is involved, round to whole numbers
                            displayRate = Math.round(displayRate);
                        } else {
                            // If both currencies are non-IRR, preserve 2 decimal places
                            displayRate = Math.round(displayRate * 100) / 100;
                        }
                        console.log('Setting calculator rate to:', displayRate);

                        // Set the rate
                        document.getElementById('calcRateInput').value = displayRate;

                        // Sync hidden rate input for main form compatibility
                        const hiddenRateInput = document.getElementById('rateInput');
                        if (hiddenRateInput) {
                            hiddenRateInput.value = displayRate;
                        }

                        // Auto-calculate if amount is already entered
                        const existingAmount = document.getElementById('calcFromAmountInput').value;
                        console.log('Existing fromAmount:', existingAmount);
                        if (existingAmount) {
                            calculateFromAmountChange();
                        }
                    } else {
                        console.log('Failed to load rate:', data);
                    }
                })
                .catch(error => {
                    console.error('Error loading rate for calculator:', error);
                });
        }

        // Calculate when FROM amount changes
        function calculateFromAmountChange() {
            console.log('=== calculateFromAmountChange called ===');
            const fromAmount = parseFloat(document.getElementById('calcFromAmountInput').value);
            const rate = parseFloat(document.getElementById('calcRateInput').value);

            console.log('From amount:', fromAmount, 'Rate:', rate);
            console.log('calcFromCurrencyCode:', calcFromCurrencyCode, 'calcToCurrencyCode:', calcToCurrencyCode);

            if (fromAmount && rate && rate > 0 && calcFromCurrencyCode && calcToCurrencyCode) {
                const fromCode = calcFromCurrencyCode;
                let toAmount;

                if (fromCode.toUpperCase() === 'IRR') {
                    // FROM is IRR, TO is foreign currency
                    toAmount = fromAmount / rate;
                    toAmount = Math.round(toAmount * 1000) / 1000;
                } else {
                    // FROM is foreign currency, TO is IRR
                    toAmount = fromAmount * rate;
                    toAmount = Math.round(toAmount);
                }

                console.log('Calculated toAmount:', toAmount);
                document.getElementById('calcToAmountInput').value = toAmount;
                showInlineCalculationResult(fromAmount, toAmount, rate);

                // Immediately update main form
                updateMainFormFromCalculator(fromAmount, rate);
            } else {
                console.log('Clearing toAmount - invalid inputs');
                document.getElementById('calcToAmountInput').value = '';
                clearMainForm();
            }
        }

        // Calculate when TO amount changes
        function calculateToAmountChange() {
            console.log('=== calculateToAmountChange called ===');
            const toAmount = parseFloat(document.getElementById('calcToAmountInput').value);
            const rate = parseFloat(document.getElementById('calcRateInput').value);

            console.log('To amount:', toAmount, 'Rate:', rate);
            console.log('calcFromCurrencyCode:', calcFromCurrencyCode, 'calcToCurrencyCode:', calcToCurrencyCode);

            if (toAmount && rate && rate > 0 && calcFromCurrencyCode && calcToCurrencyCode) {
                const fromCode = calcFromCurrencyCode;
                let fromAmount;

                if (fromCode.toUpperCase() === 'IRR') {
                    // FROM is IRR, TO is foreign currency
                    fromAmount = toAmount * rate;
                    fromAmount = Math.round(fromAmount);
                } else {
                    // FROM is foreign currency, TO is IRR
                    fromAmount = toAmount / rate;
                    fromAmount = Math.round(fromAmount * 1000) / 1000;
                }

                console.log('Calculated fromAmount:', fromAmount);
                document.getElementById('calcFromAmountInput').value = fromAmount;
                showInlineCalculationResult(fromAmount, toAmount, rate);

                // Immediately update main form
                updateMainFormFromCalculator(fromAmount, rate);
            } else {
                console.log('Clearing fromAmount - invalid inputs');
                document.getElementById('calcFromAmountInput').value = '';
                clearMainForm();
            }
        }

        // Calculate when rate changes
        function calculateRateChange() {
            console.log('=== calculateRateChange called ===');
            const rate = parseFloat(document.getElementById('calcRateInput').value);
            const fromAmount = parseFloat(document.getElementById('calcFromAmountInput').value);

            console.log('Rate changed to:', rate, 'FromAmount:', fromAmount);

            // Sync the hidden rateInput for main form compatibility
            const hiddenRateInput = document.getElementById('rateInput');
            if (hiddenRateInput && rate) {
                hiddenRateInput.value = rate;
            }

            if (rate && rate > 0 && fromAmount) {
                // Recalculate TO amount based on FROM amount and new rate
                calculateFromAmountChange();
            } else if (rate && rate > 0) {
                // Just clear TO amount if no FROM amount
                console.log('Rate valid but no fromAmount, clearing toAmount');
                document.getElementById('calcToAmountInput').value = '';
            } else {
                console.log('Invalid rate, clearing everything');
                clearMainForm();
            }
        }

        // Update main form immediately from calculator values
        function updateMainFormFromCalculator(fromAmount, rate) {
            console.log('=== updateMainFormFromCalculator called ===');
            console.log('Updating main form with fromAmount:', fromAmount, 'rate:', rate);
            console.log('calcFromCurrencyCode:', calcFromCurrencyCode, 'calcToCurrencyCode:', calcToCurrencyCode);

            if (fromAmount && rate && rate > 0 && calcFromCurrencyCode) {
                // Set amount in main form
                document.getElementById('amountInput').value = fromAmount;
                console.log('Set amountInput to:', fromAmount);

                // Convert calculator rate to main form format
                const fromCode = calcFromCurrencyCode;
                let mainFormRate;

                if (fromCode && fromCode.toUpperCase() === 'IRR') {
                    mainFormRate = 1 / rate;
                } else {
                    mainFormRate = rate;
                }

                console.log('Setting main form rate to:', mainFormRate, '(fromCode:', fromCode, ')');
                document.getElementById('rateInput').value = mainFormRate;
                document.getElementById('hiddenRate').value = mainFormRate;

                // Calculate total amount
                const totalAmount = fromAmount * mainFormRate;
                document.getElementById('hiddenTotalAmount').value = totalAmount;
                console.log('Set hiddenTotalAmount to:', totalAmount);

                // Trigger main form calculation update
                updateCalculation();
                console.log('Main form updated successfully');
            }
        }

        // Clear main form when calculator is invalid
        function clearMainForm() {
            console.log('=== clearMainForm called ===');
            document.getElementById('amountInput').value = '';
            document.getElementById('rateInput').value = '';
            document.getElementById('hiddenRate').value = '0';
            document.getElementById('hiddenTotalAmount').value = '0';
            document.getElementById('calculationResult').style.display = 'none';
            console.log('Main form cleared');
        }

        // Show calculation result
        function showInlineCalculationResult(fromAmount, toAmount, rate) {
            console.log('=== showInlineCalculationResult called ===');
            console.log('Parameters:', fromAmount, toAmount, rate);
            console.log('Currency codes:', calcFromCurrencyCode, calcToCurrencyCode);

            const fromCode = calcFromCurrencyCode;
            const toCode = calcToCurrencyCode;

            // Check if currency codes are defined
            if (!fromCode || !toCode) {
                console.error('Currency codes not defined:', fromCode, toCode);
                return;
            }

            const formattedFromAmount = formatCurrency(fromAmount, fromCode);
            const formattedToAmount = formatCurrency(toAmount, toCode);
            const formattedRate = formatCurrency(rate, 'IRR');

            const formula = `${formattedFromAmount} ${fromCode} → ${formattedToAmount} ${toCode}`;
            const details = `نرخ: ۱ ${fromCode.toUpperCase() === 'IRR' ? toCode : fromCode} = ${formattedRate} IRR`;

            console.log('Calculation result:', formula, details);

            // Note: Display elements removed - calculation result only logged
        }

        // Calculate result based on inline calculator inputs (legacy - keeping for compatibility)
        function calculateInlineResult() {
            calculateFromAmountChange();
        }

        // Add event listeners - Use Select2 events since Select2 replaces the original elements
        $('#fromCurrencySelect').on('select2:select', function (e) {
            console.log('From currency changed via Select2');
            var fromCurrency = $('#fromCurrencySelect').val();
            var toCurrency = $('#toCurrencySelect').val();
            console.log('From currency:', fromCurrency, 'To currency:', toCurrency);
            updateButtonStates(); // Update button states

            if (fromCurrency && toCurrency && fromCurrency !== toCurrency) {
                console.log('Loading exchange rate...');
                showCurrencyPoolInfo(fromCurrency, toCurrency);
            } else {
                console.log('Hiding rate display - invalid currencies');
                document.getElementById('calculationResult').style.display = 'none';
                document.getElementById('currencyPoolInfo').style.display = 'none';
            }
        });

        $('#toCurrencySelect').on('select2:select', function (e) {
            console.log('To currency changed via Select2');
            var fromCurrency = $('#fromCurrencySelect').val();
            var toCurrency = $('#toCurrencySelect').val();
            console.log('From currency:', fromCurrency, 'To currency:', toCurrency);
            updateButtonStates(); // Update button states

            if (fromCurrency && toCurrency && fromCurrency !== toCurrency) {
                console.log('Loading exchange rate...');
                showCurrencyPoolInfo(fromCurrency, toCurrency);
            } else {
                console.log('Hiding rate display - invalid currencies');
                document.getElementById('calculationResult').style.display = 'none';
                document.getElementById('currencyPoolInfo').style.display = 'none';
            }
        });
        // Add event listeners with null checks
        const amountInput = document.getElementById('amountInput');
        if (amountInput) {
            amountInput.addEventListener('input', updateCalculation);
        }

        // Add event listener for manual rate input with validation
        const rateInput = document.getElementById('rateInput');
        if (rateInput) {
            rateInput.addEventListener('input', function () {
                var rateValue = parseFloat(this.value);
                if (!isNaN(rateValue) && rateValue > 0) {
                    // Get from currency code to determine rounding precision using Select2
                    const fromSelect = $('#fromCurrencySelect');
                    let fromCode = null;
                    if (fromSelect.val()) {
                        const fromData = fromSelect.select2('data')[0];
                        fromCode = fromData.text.split(' - ')[0].trim();
                    }

                    // Determine rounding precision based on currency
                    const roundingFactor = (fromCode && fromCode.toUpperCase() === 'IRR') ? 10000000 : 100;

                    // Round to appropriate decimal places
                    var roundedRate = Math.round(rateValue * roundingFactor) / roundingFactor;

                    if (roundedRate !== rateValue) {
                        this.value = roundedRate;
                    }
                }
                updateCalculation();
            });
        }

        // Add event listener for load suggested rate button  
        const loadSuggestedRateBtn = document.getElementById('loadSuggestedRateBtn');
        if (loadSuggestedRateBtn) {
            loadSuggestedRateBtn.addEventListener('click', function () {
                var fromCurrency = $('#fromCurrencySelect').val();
                var toCurrency = $('#toCurrencySelect').val();
                console.log('Load suggested rate clicked - From:', fromCurrency, 'To:', toCurrency);
                if (fromCurrency && toCurrency && fromCurrency !== toCurrency) {
                    // Note: Exchange rate loading functionality has been removed
                    console.log('Exchange rate loading is no longer available');
                } else {
                    alert('لطفاً ابتدا ارز مبدأ و مقصد را انتخاب کنید.');
                }
            });
        }

        // Add form submission validation
        document.querySelector('form').addEventListener('submit', function (e) {
            var fromCurrency = $('#fromCurrencySelect').val();
            var toCurrency = $('#toCurrencySelect').val();
            var amount = document.getElementById('amountInput').value;
            var customerId = document.getElementById('customerSelect').value;
            var rate = document.getElementById('rateInput').value;
            if (!customerId || !fromCurrency || !toCurrency || !amount || !rate || rate === '0') {
                e.preventDefault();
                alert('لطفاً تمام فیلدهای ضروری را تکمیل کنید.');
                return false;
            }
            if (fromCurrency === toCurrency) {
                e.preventDefault();
                alert('ارز مبدأ و مقصد نمی‌توانند یکسان باشند.');
                return false;
            }
            if (parseFloat(rate) <= 0) {
                e.preventDefault();
                alert('نرخ ارز باید بزرگتر از صفر باشد.');
                return false;
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Set default date and time to current date/time
            const now = new Date();
            const formattedDateTime = now.getFullYear() + '-' +
                String(now.getMonth() + 1).padStart(2, '0') + '-' +
                String(now.getDate()).padStart(2, '0') + 'T' +
                String(now.getHours()).padStart(2, '0') + ':' +
                String(now.getMinutes()).padStart(2, '0');
            document.getElementById('createdAtInput').value = formattedDateTime;

            // Initialize Select2 if available
            if (typeof $.fn.select2 !== 'undefined') {
                console.log('Initializing Select2...');
                $('#fromCurrencySelect').select2();
                $('#toCurrencySelect').select2();
                $('#customerSelect').select2();
            } else {
                console.log('Select2 not available, using regular select events');
                // Add fallback event listeners for regular select change
                document.getElementById('fromCurrencySelect').addEventListener('change', function () {
                    console.log('From currency changed via regular event');
                    updateButtonStates();
                    var fromCurrency = this.value;
                    var toCurrency = document.getElementById('toCurrencySelect').value;
                    if (fromCurrency && toCurrency && fromCurrency !== toCurrency) {
                        showCurrencyPoolInfo(fromCurrency, toCurrency);
                    }
                });

                document.getElementById('toCurrencySelect').addEventListener('change', function () {
                    console.log('To currency changed via regular event');
                    updateButtonStates();
                    var fromCurrency = document.getElementById('fromCurrencySelect').value;
                    var toCurrency = this.value;
                    if (fromCurrency && toCurrency && fromCurrency !== toCurrency) {
                        showCurrencyPoolInfo(fromCurrency, toCurrency);
                    }
                });
            }

            // Initialize button states
            updateButtonStates();

            // Add inline calculator event listeners for immediate calculation with null checks
            const calcFromAmountInput = document.getElementById('calcFromAmountInput');
            if (calcFromAmountInput) {
                calcFromAmountInput.addEventListener('input', calculateFromAmountChange);
            }

            const calcToAmountInput = document.getElementById('calcToAmountInput');
            if (calcToAmountInput) {
                calcToAmountInput.addEventListener('input', calculateToAmountChange);
            }

            const calcRateInput = document.getElementById('calcRateInput');
            if (calcRateInput) {
                calcRateInput.addEventListener('input', calculateRateChange);
            }
        });
    </script>
}