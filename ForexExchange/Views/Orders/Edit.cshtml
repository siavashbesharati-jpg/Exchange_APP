@model ForexExchange.Models.Order

@{
    ViewData["Title"] = "ویرایش معامله";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form asp-action="Edit" method="post">
                        @Html.AntiForgeryToken()
                        @if (!ViewData.ModelState.IsValid && ViewData.ModelState.Values.Any(v => v.Errors.Count > 0)) {
                            <div class="alert alert-danger mt-2" id="validationSummaryBox">
                                <ul class="mb-0">
                                @foreach (var state in ViewData.ModelState.Values)
                                    {
                                        foreach (var error in state.Errors)
                                        {
                                            var msg = error.ErrorMessage;
                                            if (msg == "The CustomerId field is required.") msg = "انتخاب مشتری الزامی است.";
                                            if (msg == "The FromCurrencyId field is required.") msg = "انتخاب ارز مبدأ الزامی است.";
                                            if (msg == "The ToCurrencyId field is required.") msg = "انتخاب ارز مقصد الزامی است.";
                                            if (msg == "The Amount field is required.") msg = "مقدار  معامله الزامی است.";
                                            <li>@msg</li>
                                        }
                                    }
                                }
                                </ul>
                            </div>
                        }
                        <div class="alert alert-info mt-2" id="currencyPairMsgBox" style="display: none;"></div>

                        <input asp-for="Id" type="hidden" />

                        <div class="row mb-3">
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="alert alert-warning" id="currencyPoolInfo" style="display: none;" dir="ltr">
                                        <h6>موجودی صندوق  ارزها:</h6>
                                        <p id="currencyPoolText"></p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="CustomerId" class="form-label">انتخاب مشتری</label>
                                <select asp-for="CustomerId" asp-items="ViewBag.Customers" class="form-select" id="customerSelect" required>
                                    <option value="">یک مشتری انتخاب کنید</option>
                                </select>
                                <span asp-validation-for="CustomerId" class="text-danger"></span>
                            </div>
                            <!-- Removed OrderType dropdown -->
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label asp-for="FromCurrencyId" class="form-label"> خرید </label>
                                <select asp-for="FromCurrencyId" asp-items="ViewBag.FromCurrencies" class="form-select" id="fromCurrencySelect" required>
                                    <option value="">انتخاب کنید</option>
                                </select>
                                <span asp-validation-for="FromCurrencyId" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="ToCurrencyId" class="form-label">  فروش </label>
                                <select asp-for="ToCurrencyId" asp-items="ViewBag.ToCurrencies" class="form-select" id="toCurrencySelect" required>
                                    <option value="">انتخاب کنید</option>
                                </select>
                                <span asp-validation-for="ToCurrencyId" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Amount" class="form-label">مقدار  (ارز مبدأ)</label>
                                <input asp-for="Amount" type="number" class="form-control" step="0.01" id="amountInput" required />
                                <span asp-validation-for="Amount" class="text-danger"></span>
                                <div class="form-text">مقادیر منفی برای تراکنش‌های برگشتی مجاز است</div>
                            </div>
                        </div>

                        <!-- Exchange Rate Display -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">نرخ ارز:</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div id="selectedExchangeRate" class="alert alert-info" style="display: none;">
                                                    <div id="rateInfo"></div>
                                                    <div class="spinner-border spinner-border-sm" id="rateLoader" style="display: none;" role="status">
                                                        <span class="visually-hidden">در حال بارگذاری...</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label asp-for="Rate" class="form-label">نرخ قابل ویرایش</label>
                                                <div class="input-group">
                                                    <input asp-for="Rate" type="number" class="form-control" step="any" id="rateInput" placeholder="نرخ ارز را وارد کنید" />
                                                    <button class="btn btn-outline-secondary" type="button" id="loadSuggestedRateBtn" title="بارگذاری نرخ پیشنهادی">
                                                        <i class="bi bi-arrow-clockwise"></i>
                                                    </button>
                                                </div>
                                                <div class="form-text">
                                                    <small class="text-muted">نرخ ارز را به صورت دستی وارد کنید یا از نرخ پیشنهادی استفاده کنید</small>
                                                </div>
                                                <span asp-validation-for="Rate" class="text-danger"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Calculation Result -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="alert alert-info" id="calculationResult" style="display: none;">
                                    <h6>محاسبه خودکار:</h6>
                                    <p id="calculationText" dir="ltr"></p>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="CreatedAt" class="form-label">تاریخ و زمان معامله</label>
                                <input asp-for="CreatedAt" type="datetime-local" class="form-control" id="createdAtInput" />
                                <span asp-validation-for="CreatedAt" class="text-danger"></span>
                                <div class="form-text">تاریخ و زمان ثبت معامله</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Notes" class="form-label">توضیحات (اختیاری)</label>
                            <textarea asp-for="Notes" class="form-control" rows="3" placeholder="توضیحات اضافی در مورد معامله..."></textarea>
                            <span asp-validation-for="Notes" class="text-danger"></span>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-action="Index" class="btn btn-secondary">بازگشت به لیست</a>
                            <button type="submit" class="btn btn-primary">بروزرسانی معامله</button>
                        </div>

                        <!-- Hidden fields for calculated values -->
                        <input type="hidden" asp-for="TotalAmount" id="hiddenTotalAmount" />
                        <input type="hidden" asp-for="Rate" id="hiddenRate" />
                        <input type="hidden" asp-for="FilledAmount" />
                        
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
    
    <!-- Include Currency Formatter -->
    <script src="~/js/currency-formatter.js"></script>
    
    <script>
        let currentRate = null;
        let currencyPools = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.PoolData ?? new Dictionary<string, decimal>()));

        function updateRateInputStep(fromCurrencyCode = null) { return; }

        function formatNumber(num, fromCurrencyCode = null) {
            // Use the universal currency formatter
            return formatCurrency(num, fromCurrencyCode);
        }

        function showCurrencyPoolInfo(fromCurrencyId, toCurrencyId) {
            // Get currency codes from Select2 data
            const fromSelect = $('#fromCurrencySelect');
            const toSelect = $('#toCurrencySelect');
            
            let fromCode = null, toCode = null;
            
            if (fromSelect.val()) {
                const fromData = fromSelect.select2('data')[0];
                fromCode = fromData.text.split(' - ')[0].trim();
            }
            
            if (toSelect.val()) {
                const toData = toSelect.select2('data')[0];
                toCode = toData.text.split(' - ')[0].trim();
            }
            
            console.log('currencyPools:', currencyPools);
            console.log('fromCode:', fromCode, 'toCode:', toCode);
            let html = '';
            if (fromCode && Object.prototype.hasOwnProperty.call(currencyPools, fromCode)) {
                const fromVal = currencyPools[fromCode];
                const fromBadge = fromVal < 0 ? 'badge bg-danger' : 'badge bg-success';
                html += `<strong>موجودی ${fromCode}:</strong> <span class="${fromBadge}">${formatCurrency(fromVal, fromCode)}</span>`;
            }
            if (toCode && Object.prototype.hasOwnProperty.call(currencyPools, toCode)) {
                const toVal = currencyPools[toCode];
                const toBadge = toVal < 0 ? 'badge bg-danger' : 'badge bg-success';
                html += `<br><strong>موجودی ${toCode}:</strong> <span class="${toBadge}">${formatCurrency(toVal, toCode)}</span>`;
            }
            if (html) {
                document.getElementById('currencyPoolText').innerHTML = html;
                document.getElementById('currencyPoolInfo').style.display = 'block';
            } else {
                document.getElementById('currencyPoolInfo').style.display = 'none';
            }
        }

        function loadExchangeRate(fromCurrencyId, toCurrencyId) {
            console.log('loadExchangeRate called with:', fromCurrencyId, toCurrencyId);
            document.getElementById('selectedExchangeRate').style.display = 'block';
            document.getElementById('rateLoader').style.display = 'inline-block';
            document.getElementById('rateInfo').innerHTML = 'در حال بارگذاری نرخ ارز...';
            const url = `/Orders/GetExchangeRate?fromCurrencyId=${fromCurrencyId}&toCurrencyId=${toCurrencyId}&orderType=Buy`;
            console.log('Fetching rate from URL:', url);
            fetch(url)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Rate data received:', data);
                    document.getElementById('rateLoader').style.display = 'none';
                    if (data.success) {
                        if (data.rate > 0) {
                            // Get from currency code for conditional rounding using Select2
                            const fromSelect = $('#fromCurrencySelect');
                            let fromCode = null;
                            if (fromSelect.val()) {
                                const fromData = fromSelect.select2('data')[0];
                                fromCode = fromData.text.split(' - ')[0].trim();
                            }
                            const roundingFactor = (fromCode && fromCode.toUpperCase() === 'IRR') ? 10000000 : 100;
                            const roundedRate = Math.round(data.rate * roundingFactor) / roundingFactor;
                            currentRate = roundedRate;
                            let rateInfoHtml = `<strong>نرخ پیشنهادی:</strong> ${formatNumber(roundedRate, fromCode)} <small class="text-muted">(${data.source})</small>`;
                            if (data.averageBuyRate) {
                                const roundedBuyRate = Math.round(data.averageBuyRate * roundingFactor) / roundingFactor;
                                rateInfoHtml += `<br><strong>میانگین نرخ :</strong> ${formatNumber(roundedBuyRate, fromCode)}`;
                            }
                            if (data.averageSellRate) {
                                const roundedSellRate = Math.round(data.averageSellRate * roundingFactor) / roundingFactor;
                                rateInfoHtml += `<br><strong>میانگین نرخ :</strong> ${formatNumber(roundedSellRate, fromCode)}`;
                            }
                            document.getElementById('rateInfo').innerHTML = rateInfoHtml;
                            const rateInput = document.getElementById('rateInput');
                            rateInput.value = roundedRate;
                            document.getElementById('hiddenRate').value = roundedRate;
                            updateCalculation();
                        } else {
                            document.getElementById('rateInfo').innerHTML = '<span class="text-warning">نرخ ارز برای این جفت ارز موجود نیست</span>';
                        }
                    } else {
                        document.getElementById('rateInfo').innerHTML = `<span class="text-danger">خطا: ${data.error}</span>`;
                    }
                })
                .catch(error => {
                    document.getElementById('rateLoader').style.display = 'none';
                    document.getElementById('rateInfo').innerHTML = '<span class="text-danger">خطا در بارگذاری نرخ ارز</span>';
                    console.error('Error loading exchange rate:', error);
                });
        }

        function updateCalculation() {
            var amount = document.getElementById('amountInput').value;
            var rate = document.getElementById('rateInput').value;
            // Get from currency code using Select2
            const fromSelect = $('#fromCurrencySelect');
            let fromCode = null;
            if (fromSelect.val()) {
                const fromData = fromSelect.select2('data')[0];
                fromCode = fromData.text.split(' - ')[0].trim();
            }
            if (amount && rate && parseFloat(rate) > 0) {
                var total = parseFloat(amount) * parseFloat(rate);
                document.getElementById('calculationText').innerHTML = `${formatCurrency(parseFloat(amount), fromCode)} × ${formatNumber(parseFloat(rate), fromCode)} = <strong>${formatCurrency(total, 'IRR')}</strong>`;
                document.getElementById('calculationResult').style.display = 'block';
                document.getElementById('hiddenTotalAmount').value = total;
                document.getElementById('hiddenRate').value = rate;
            } else {
                document.getElementById('calculationResult').style.display = 'none';
                document.getElementById('hiddenTotalAmount').value = '0';
                document.getElementById('hiddenRate').value = '0';
            }
        }

        // Use Select2 events since Select2 replaces the original elements
        $('#fromCurrencySelect').on('select2:select', function (e) {
            console.log('From currency changed via Select2');
            var fromCurrency = $('#fromCurrencySelect').val();
            var toCurrency = $('#toCurrencySelect').val();
            console.log('From currency:', fromCurrency, 'To currency:', toCurrency);
            
            if (fromCurrency && toCurrency && fromCurrency !== toCurrency) {
                console.log('Loading exchange rate...');
                loadExchangeRate(fromCurrency, toCurrency);
                showCurrencyPoolInfo(fromCurrency, toCurrency);
            } else {
                console.log('Hiding rate display - invalid currencies');
                document.getElementById('selectedExchangeRate').style.display = 'none';
                document.getElementById('calculationResult').style.display = 'none';
                document.getElementById('currencyPoolInfo').style.display = 'none';
            }
        });
        
        $('#toCurrencySelect').on('select2:select', function (e) {
            console.log('To currency changed via Select2');
            var fromCurrency = $('#fromCurrencySelect').val();
            var toCurrency = $('#toCurrencySelect').val();
            console.log('From currency:', fromCurrency, 'To currency:', toCurrency);
            
            if (fromCurrency && toCurrency && fromCurrency !== toCurrency) {
                console.log('Loading exchange rate...');
                loadExchangeRate(fromCurrency, toCurrency);
                showCurrencyPoolInfo(fromCurrency, toCurrency);
            } else {
                console.log('Hiding rate display - invalid currencies');
                document.getElementById('selectedExchangeRate').style.display = 'none';
                document.getElementById('calculationResult').style.display = 'none';
                document.getElementById('currencyPoolInfo').style.display = 'none';
            }
        });
        document.getElementById('amountInput').addEventListener('input', updateCalculation);

        document.getElementById('rateInput').addEventListener('input', function() {
            var rateValue = parseFloat(this.value);
            if (!isNaN(rateValue) && rateValue > 0) {
                // Get from currency code to determine rounding precision using Select2
                const fromSelect = $('#fromCurrencySelect');
                let fromCode = null;
                if (fromSelect.val()) {
                    const fromData = fromSelect.select2('data')[0];
                    fromCode = fromData.text.split(' - ')[0].trim();
                }
                const roundingFactor = (fromCode && fromCode.toUpperCase() === 'IRR') ? 10000000 : 100;
                var roundedRate = Math.round(rateValue * roundingFactor) / roundingFactor;
                if (roundedRate !== rateValue) { this.value = roundedRate; }
            }
            updateCalculation();
        });

        document.getElementById('loadSuggestedRateBtn').addEventListener('click', function() {
            var fromCurrency = $('#fromCurrencySelect').val();
            var toCurrency = $('#toCurrencySelect').val();
            console.log('Load suggested rate clicked - From:', fromCurrency, 'To:', toCurrency);
            if (fromCurrency && toCurrency && fromCurrency !== toCurrency) {
                loadExchangeRate(fromCurrency, toCurrency);
            } else {
                alert('لطفاً ابتدا ارز مبدأ و مقصد را انتخاب کنید.');
            }
        });

        document.querySelector('form').addEventListener('submit', function (e) {
            var fromCurrency = $('#fromCurrencySelect').val();
            var toCurrency = $('#toCurrencySelect').val();
            var amount = document.getElementById('amountInput').value;
            var customerId = document.getElementById('customerSelect').value;
            var rate = document.getElementById('rateInput').value;
            if (!customerId || !fromCurrency || !toCurrency || !amount || !rate || rate === '0') {
                e.preventDefault();
                alert('لطفاً تمام فیلدهای ضروری را تکمیل کنید.');
                return false;
            }
            if (fromCurrency === toCurrency) {
                e.preventDefault();
                alert('ارز مبدأ و مقصد نمی‌توانند یکسان باشند.');
                return false;
            }
            if (parseFloat(rate) <= 0) {
                e.preventDefault();
                alert('نرخ ارز باید بزرگتر از صفر باشد.');
                return false;
            }
        });
    </script>
}
