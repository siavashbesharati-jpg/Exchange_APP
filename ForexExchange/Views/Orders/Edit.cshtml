@model ForexExchange.Models.Order

@{
    ViewData["Title"] = "ویرایش سفارش";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">ویرایش سفارش #@Model.Id</h4>
                </div>
                <div class="card-body">
                    <form asp-action="Edit" method="post">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                        
                        <input asp-for="Id" type="hidden" />
                        <input asp-for="CreatedAt" type="hidden" />
                        
                        <div class="row mb-3">
                           
                                <div class="col-md-6">
                                    <label asp-for="CustomerId" class="form-label">انتخاب مشتری</label>
                                    <select asp-for="CustomerId" class="form-select" required>
                                        <option value="">یک مشتری انتخاب کنید</option>
                                        @if (ViewBag.Customers != null)
                                        {
                                            @foreach (var customer in ViewBag.Customers)
                                            {
                                                <option value="@customer.Id" selected="@(customer.Id == Model.CustomerId)">@customer.FullName - @customer.PhoneNumber</option>
                                            }
                                        }
                                    </select>
                                    <span asp-validation-for="CustomerId" class="text-danger"></span>
                                </div>
                            
                           
                            
                            <!-- Removed OrderType dropdown -->
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label asp-for="FromCurrencyId" class="form-label">از ارز (مبدأ)</label>
                                <select asp-for="FromCurrencyId" class="form-select" id="fromCurrencySelect" required>
                                    <option value="">انتخاب کنید</option>
                                    @if (ViewBag.FromCurrencies != null)
                                    {
                                        @foreach (var currency in (List<ForexExchange.Models.Currency>)ViewBag.FromCurrencies)
                                        {
                                            <option value="@currency.Id" selected="@(Model.FromCurrencyId == currency.Id)">@currency.PersianName (@currency.Code)</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="FromCurrencyId" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-4">
                                <label asp-for="ToCurrencyId" class="form-label">به ارز (مقصد)</label>
                                <select asp-for="ToCurrencyId" class="form-select" id="toCurrencySelect" required>
                                    <option value="">انتخاب کنید</option>
                                    @if (ViewBag.ToCurrencies != null)
                                    {
                                        @foreach (var currency in (List<ForexExchange.Models.Currency>)ViewBag.ToCurrencies)
                                        {
                                            <option value="@currency.Id" selected="@(Model.ToCurrencyId == currency.Id)">@currency.PersianName (@currency.Code)</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="ToCurrencyId" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-4">
                                <label asp-for="Amount" class="form-label">مبلغ (ارز مبدأ)</label>
                                <input asp-for="Amount" type="number" class="form-control" step="0.01" min="0" id="amountInput" required />
                                <span asp-validation-for="Amount" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Currency Pair Information -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="alert alert-info" id="currencyPairInfo">
                                    <h6>اطلاعات جفت ارز فعلی:</h6>
                                    <p id="currencyPairText">
                                        جفت ارز: <strong>@Model.FromCurrency?.PersianName → @Model.ToCurrency?.PersianName</strong>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="Rate" class="form-label">نرخ</label>
                                <input asp-for="Rate" type="number" class="form-control" step="0.01" min="0" />
                                <span asp-validation-for="Rate" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-6">
                                <label asp-for="Status" class="form-label">وضعیت</label>
                                <select asp-for="Status" class="form-select">
                                    <option value="0" selected="@(Model.Status == ForexExchange.Models.OrderStatus.Open)">باز</option>
                                    <option value="1" selected="@(Model.Status == ForexExchange.Models.OrderStatus.Matched)">مچ شده</option>
                                    <option value="2" selected="@(Model.Status == ForexExchange.Models.OrderStatus.PartiallyFilled)">نیمه تکمیل</option>
                                    <option value="3" selected="@(Model.Status == ForexExchange.Models.OrderStatus.Completed)">تکمیل شده</option>
                                    <option value="4" selected="@(Model.Status == ForexExchange.Models.OrderStatus.Cancelled)">لغو شده</option>
                                </select>
                                <span asp-validation-for="Status" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="FilledAmount" class="form-label">مبلغ تکمیل شده</label>
                                <input asp-for="FilledAmount" type="number" class="form-control" step="0.01" min="0" />
                                <span asp-validation-for="FilledAmount" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-6">
                                <label asp-for="TotalInToman" class="form-label">کل به تومان</label>
                                <input asp-for="TotalInToman" type="number" class="form-control" step="0.01" min="0" />
                                <span asp-validation-for="TotalInToman" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Exchange Rate Display -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">نرخ‌های ارز فعلی:</h6>
                                        <div class="row" id="exchangeRates">
                                            @if (ViewBag.ExchangeRates != null)
                                            {
                                                @foreach (var rate in ViewBag.ExchangeRates)
                                                {
                                                    <div class="col-md-4 mb-2" data-from-currency="@rate.FromCurrencyId" data-to-currency="@rate.ToCurrencyId">
                                                        <div class="small">
                                                            <strong>
                                                                @rate.FromCurrency?.PersianName → @rate.ToCurrency?.PersianName
                                                            </strong><br>
                                                            خرید: <span class="text-success">@rate.BuyRate.ToString("N0")</span><br>
                                                            فروش: <span class="text-danger">@rate.SellRate.ToString("N0")</span>
                                                        </div>
                                                    </div>
                                                }
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Calculation Result -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="alert alert-info" id="calculationResult" style="display: none;">
                                    <h6>محاسبه خودکار:</h6>
                                    <p id="calculationText"></p>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Notes" class="form-label">توضیحات (اختیاری)</label>
                            <textarea asp-for="Notes" class="form-control" rows="3" placeholder="توضیحات اضافی در مورد سفارش...">@Model.Notes</textarea>
                            <span asp-validation-for="Notes" class="text-danger"></span>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-action="Index" class="btn btn-secondary">بازگشت به لیست</a>
                            <button type="submit" class="btn btn-primary">بروزرسانی سفارش</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        // Exchange rates data from ViewBag
        var exchangeRates = @Html.Raw(Json.Serialize(ViewBag.ExchangeRates));
        
        // Currency names mapping
        function getCurrencyName(currencyValue) {
            switch(parseInt(currencyValue)) {
                case 0: return 'تومان';
                case 1: return 'دلار آمریکا';
                case 2: return 'یورو';
                case 3: return 'درهم امارات';
                case 4: return 'ریال عمان';
                case 5: return 'لیر ترکیه';
                default: return '';
            }
        }
        
        function getCurrencyCode(currencyValue) {
            switch(parseInt(currencyValue)) {
                case 0: return 'IRR';
                case 1: return 'USD';
                case 2: return 'EUR';
                case 3: return 'AED';
                case 4: return 'OMR';
                case 5: return 'TRY';
                default: return '';
            }
        }
        
        function updateCurrencyPairInfo() {
            var fromCurrency = document.getElementById('fromCurrencySelect').value;
            var toCurrency = document.getElementById('toCurrencySelect').value;
            
            // Prevent same currency selection
            if (fromCurrency && toCurrency && fromCurrency === toCurrency) {
                document.getElementById('currencyPairText').innerHTML = '<span class="text-danger">خطا: ارز مبدأ و مقصد نمی‌توانند یکسان باشند</span>';
                return;
            }
            
            if (fromCurrency && toCurrency) {
                var fromName = getCurrencyName(fromCurrency);
                var toName = getCurrencyName(toCurrency);
                var fromCode = getCurrencyCode(fromCurrency);
                var toCode = getCurrencyCode(toCurrency);
                
                document.getElementById('currencyPairText').innerHTML = 
                    `جفت ارز: <strong>${fromName} (${fromCode}) → ${toName} (${toCode})</strong>`;
            }
        
        // Add event listeners for cross-currency functionality
        document.getElementById('fromCurrencySelect').addEventListener('change', updateCurrencyPairInfo);
        document.getElementById('toCurrencySelect').addEventListener('change', updateCurrencyPairInfo);
    // Removed OrderType event listener
        
        // Initial update on page load
        updateCurrencyPairInfo();
    </script>
}
