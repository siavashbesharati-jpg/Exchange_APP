@using System.Linq
@using ForexExchange.Extensions
@model ForexExchange.Models.AllCustomersBalanceReportData
@inject ForexExchange.Services.ISettingsService SettingsService
@{
    ViewData["Title"] = "گزارش تراز همه مشتریان";
    Layout = null; // Print-friendly
    var websiteName = await SettingsService.GetWebsiteNameAsync();
    var companyName = await SettingsService.GetCompanyNameAsync();
    var companyWebsite = await SettingsService.GetCompanyWebsiteAsync();
    var logoDataUrl = await SettingsService.GetLogoDataUrlAsync();
    var summary = Model?.Summary;
    var customers = Model?.Customers ?? new List<ForexExchange.Models.AllCustomerBalancePrintViewModel>();
}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - @websiteName</title>
    <link rel="icon" type="image/png" href="@logoDataUrl">
    <link rel="shortcut icon" href="@logoDataUrl">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; direction: rtl; background: #f8f9fa; color: #333; font-size: 12px; }
        .receipt-container { max-width: 1000px; margin: 20px auto; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.1); border: 2px solid #ddd; }
        .receipt-header { background: #001f4d; color: white; padding: 15px 20px; display: flex; align-items: center; gap: 15px; }
        .company-logo img { width: 32px; height: 32px; border-radius: 50%; }
        .company-info { flex: 1; }
        .company-name { font-size: 20px; font-weight: bold; }
        .company-website { font-size: 12px; opacity: 0.9; }
        .report-title { font-size: 18px; font-weight: bold; margin-right: auto; }
        .table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .table th { background: #f8f9fa; }
        .customer-row { background: #f0f4ff; font-weight: bold; }
        .balance-positive { color: #27ae60; }
        .balance-negative { color: #e74c3c; }
        .footer { background: #2c3e50; color: white; padding: 10px 20px; text-align: center; font-size: 11px; }
        .summary-grid { display: flex; gap: 10px; justify-content: space-between; margin: 20px 0; flex-wrap: wrap; }
        .summary-card { flex: 1 1 200px; background: #f0f4ff; border: 1px solid #ccd6f6; border-radius: 8px; padding: 15px; text-align: center; }
        .summary-card h4 { margin: 0; font-size: 18px; color: #001f4d; }
        .summary-card span { display: block; margin-top: 6px; font-size: 12px; color: #555; }
        .currency-summary { margin: 20px 0; }
        .currency-summary table { width: 100%; border-collapse: collapse; }
        .currency-summary th, .currency-summary td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .currency-summary th { background: #eef2ff; }
        .currency-summary td { font-size: 12px; }
    @@media print { body { background: white; } .receipt-container { box-shadow: none; border: 1px solid #000; } .footer { background: #2c3e50 !important; } .no-print { display: none !important; } }
    </style>
</head>
<body>
    <div class="receipt-container">
        <div class="receipt-header">
            <div class="company-logo"><img src="@logoDataUrl" alt="لوگو @companyName" /></div>
            <div class="company-info">
                <div class="company-name">@companyName</div>
                <div class="company-website">@companyWebsite</div>
            </div>
            <div class="report-title">گزارش تراز همه مشتریان</div>
        </div>
        @if (summary != null)
        {
            <div class="summary-grid">
                <div class="summary-card">
                    <h4>@summary.TotalCustomersWithBalances</h4>
                    <span>کل مشتریان با تراز</span>
                </div>
                <div class="summary-card">
                    <h4>@summary.TotalCustomersWithCredit</h4>
                    <span>مشتریان بستانکار</span>
                </div>
                <div class="summary-card">
                    <h4>@summary.TotalCustomersWithDebt</h4>
                    <span>مشتریان بدهکار</span>
                </div>
                <div class="summary-card">
                    <h4>@(summary.CurrencyFilter ?? "همه ارزها")</h4>
                    <span>فیلتر ارز</span>
                </div>
            </div>

            if (summary.CurrencyTotals.Any())
            {
                <div class="currency-summary">
                    <table>
                        <thead>
                            <tr>
                                <th>ارز</th>
                                <th>تعداد مشتری</th>
                                <th>جمع بستانکار</th>
                                <th>جمع بدهکار</th>
                                <th>تراز</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var entry in summary.CurrencyTotals.OrderBy(e => e.Key))
                            {
                                var currencyCode = entry.Key;
                                var totals = entry.Value;
                                var creditFormatted = totals.TotalCredit.FormatCurrency(currencyCode);
                                var debtFormatted = totals.TotalDebt.FormatCurrency(currencyCode);
                                var netFormatted = totals.NetBalance.FormatCurrency(currencyCode);
                                var netClass = totals.NetBalance >= 0 ? "balance-positive" : "balance-negative";
                                <tr>
                                    <td>@currencyCode</td>
                                    <td>@totals.CustomerCount</td>
                                       <td class="balance-positive" dir="ltr">@creditFormatted</td>
                                       <td class="balance-negative" dir="ltr">@(totals.TotalDebt > 0 ? "-" + debtFormatted : debtFormatted)</td>
                                       <td class="@netClass" dir="ltr">@netFormatted</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        }
        <table class="table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>نام مشتری</th>
                    <th>کد مشتری</th>
                    <th>ارز</th>
                    <th>تراز</th>
                </tr>
            </thead>
            <tbody>
                @if (customers.Any())
                {
                    int row = 1;
                    foreach (var customer in customers)
                    {
                        foreach (var bal in customer.Balances)
                        {
                            <tr>
                                <td>@row</td>
                                <td>@customer.FullName</td>
                                <td>@customer.CustomerId</td>
                                <td>@bal.CurrencyCode</td>
                                    <td class="@(bal.Balance >= 0 ? "balance-positive" : "balance-negative")" dir="ltr">@bal.Balance.FormatCurrency(bal.CurrencyCode)</td>
                            </tr>
                            row++;
                        }
                    }
                }
                else
                {
                    <tr><td colspan="5">داده‌ای برای نمایش وجود ندارد</td></tr>
                }
            </tbody>
        </table>
        <div class="footer">
            <strong>تاریخ چاپ:</strong> @DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss") |
            <strong>کاربر:</strong> @(User.FindFirst("FullName")?.Value ?? User.Identity?.Name ?? "نامشخص")<br />
            این گزارش به صورت خودکار تولید شده و نیاز به امضا ندارد • صحت اطلاعات با @companyName قابل بررسی است • @companyWebsite
        </div>
    </div>
    <div style="text-align: center; margin: 20px; padding: 20px;" class="no-print">
        <button onclick="window.print()" style="background: #27ae60; color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 14px; cursor: pointer; margin: 0 10px;">🖨️ چاپ گزارش</button>
        <button onclick="window.close()" style="background: #e74c3c; color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 14px; cursor: pointer; margin: 0 10px;">✖️ بستن</button>
    </div>
</body>
</html>


