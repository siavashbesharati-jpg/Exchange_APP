@{
    ViewData["Title"] = "گزارش روزانه بانک و مشتری";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-balance-scale text-primary me-2"></i>گزارش روزانه بانک و مشتری</h2>
                <div class="d-flex align-items-center">
                    <label for="reportDate" class="form-label me-2 mb-0">تاریخ:</label>
                    <input type="date" class="form-control me-2" id="reportDate" style="width: auto;">
                    <button type="button" class="btn btn-primary" onclick="loadCustomerBankReport()">
                        <i class="fas fa-search me-1"></i>
                        جستجو
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-center">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="changeDate(-1)">
                        <i class="fas fa-chevron-right me-1"></i>
                        روز قبل
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="setToday()">
                        <i class="fas fa-calendar-day me-1"></i>
                        امروز
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="changeDate(1)">
                        روز بعد
                        <i class="fas fa-chevron-left ms-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingIndicator" class="text-center py-5 d-none">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">در حال بارگذاری...</span>
        </div>
        <p class="text-muted">در حال بارگذاری گزارش...</p>
    </div>

    <div id="errorAlert" class="alert alert-danger d-none" role="alert"></div>

    <div id="reportContent" class="d-none">
        <div class="row" id="currencyCards"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('reportDate').value = today;
    loadCustomerBankReport();
});

function setToday() {
    document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
    loadCustomerBankReport();
}

function changeDate(offsetDays) {
    const dateInput = document.getElementById('reportDate');
    const currentDate = new Date(dateInput.value);
    currentDate.setDate(currentDate.getDate() + offsetDays);
    dateInput.value = currentDate.toISOString().split('T')[0];
    loadCustomerBankReport();
}

function loadCustomerBankReport() {
    const date = document.getElementById('reportDate').value;
    if (!date) {
        showError('لطفاً تاریخ گزارش را انتخاب کنید');
        return;
    }

    toggleLoading(true);
    hideError();

    fetch(`/Reports/GetCustomerBankDailyReport?date=${date}`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                showError(data.message || 'خطا در دریافت گزارش روزانه');
                toggleLoading(false);
                return;
            }

            renderReport(data.currencies || []);
            toggleLoading(false);
        })
        .catch(() => {
            showError('خطا در برقراری ارتباط با سرور');
            toggleLoading(false);
        });
}

function renderReport(currencies) {
    const reportContent = document.getElementById('reportContent');
    const cardsContainer = document.getElementById('currencyCards');

    cardsContainer.innerHTML = '';

    if (!currencies.length) {
        cardsContainer.innerHTML = `
            <div class="col-12">
                <div class="alert alert-info text-center">
                    برای تاریخ انتخاب شده داده‌ای یافت نشد.
                </div>
            </div>`;
        reportContent.classList.remove('d-none');
        return;
    }

    currencies.forEach(currency => {
        const currencyCode = currency.currencyCode || 'UNKNOWN';
        const safeId = currencyCode.replace(/[^a-zA-Z0-9_-]/g, '');
        const collapseId = `details-${safeId}`;
        const differenceClass = currency.difference >= 0 ? 'text-success' : 'text-danger';
        const differenceIcon = currency.difference >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';

        const bankRows = (currency.bankDetails || []).map(item => `
            <tr>
                <td>${item.bankName}</td>
                <td dir="ltr">${formatValue(item.balance, currencyCode)}</td>
            </tr>
        `).join('') || `
            <tr>
                <td colspan="2" class="text-center text-muted">داده‌ای برای نمایش وجود ندارد</td>
            </tr>`;

        const customerRows = (currency.customerDetails || []).map(item => `
            <tr>
                <td>${item.customerName}</td>
                <td dir="ltr">${formatValue(item.balance, currencyCode)}</td>
            </tr>
        `).join('') || `
            <tr>
                <td colspan="2" class="text-center text-muted">داده‌ای برای نمایش وجود ندارد</td>
            </tr>`;

        cardsContainer.innerHTML += `
            <div class="col-12 mb-4">
                <div class="card shadow-sm border-2">
                    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <h5 class="mb-0">
                                <i class="fas fa-coins me-2"></i>
                                ${currency.currencyName} (${currencyCode})
                            </h5>
                            <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false">
                                <i class="fas fa-list me-1"></i>جزئیات
                            </button>
                        </div>
                        <div class="text-end ms-auto">
                            <div class="${differenceClass} fw-bold" dir="ltr">
                                <i class="fas ${differenceIcon} me-1"></i>
                                ${formatValue(currency.difference, currencyCode)}
                            </div>
                            <small class="text-muted">اختلاف بانک + مشتری</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="border rounded p-3 h-100 bg-light">
                                    <h6 class="text-muted">مجموع بانک‌ها</h6>
                                    <div class="fs-4 fw-bold text-primary" dir="ltr">
                                        ${formatValue(currency.bankTotal, currencyCode)}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="border rounded p-3 h-100 bg-light">
                                    <h6 class="text-muted">مجموع مشتریان</h6>
                                    <div class="fs-4 fw-bold text-primary" dir="ltr">
                                        ${formatValue(currency.customerTotal, currencyCode)}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="border rounded p-3 h-100 bg-light">
                                    <h6 class="text-muted">تراز</h6>
                                    <div class="fs-4 fw-bold ${differenceClass}" dir="ltr">
                                        ${formatValue(currency.difference, currencyCode)}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="collapse mt-4" id="${collapseId}">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3">جزئیات بانک‌ها</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>بانک</th>
                                                    <th>موجودی</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${bankRows}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted mb-3">جزئیات مشتریان</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>مشتری</th>
                                                    <th>موجودی</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${customerRows}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
    });

    reportContent.classList.remove('d-none');
}

function toggleLoading(show) {
    document.getElementById('loadingIndicator').classList.toggle('d-none', !show);
    document.getElementById('reportContent').classList.toggle('d-none', show);
}

function showError(message) {
    const alert = document.getElementById('errorAlert');
    alert.textContent = message;
    alert.classList.remove('d-none');
}

function hideError() {
    document.getElementById('errorAlert').classList.add('d-none');
}

function formatValue(value, currencyCode) {
    const numericValue = Number(value) || 0;

    if (typeof window.formatCurrency === 'function') {
        return window.formatCurrency(numericValue, currencyCode);
    }

    const isIRR = currencyCode && currencyCode.toUpperCase() === 'IRR';
    if (isIRR) {
        return new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(Math.trunc(numericValue));
    }

    const truncated = Math.trunc(numericValue * 100) / 100;
    let result = new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(truncated);

    if (result.includes('.')) {
        result = result.replace(/\.0+$|\.([0-9]*[1-9])0+$/, '.$1');
    }

    return numericValue < 0 && !result.startsWith('-') ? `-${result}` : result;
}
</script>
