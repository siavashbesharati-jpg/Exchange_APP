@{
    ViewData["Title"] = "گزارشات اسناد حسابداری";
}

<div class="container-fluid">
    <!-- Header with Back Button -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h2><i class="fas fa-file-invoice text-warning me-2"></i>گزارشات اسناد حسابداری</h2>
                    <p class="text-muted">تحلیل اسناد حسابداری، رسیدها و گزارشات مالی تفصیلی</p>
                </div>
                <a href="@Url.Action("Index", "Reports")" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-right me-1"></i>بازگشت به فهرست گزارشات
                </a>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-filter me-2"></i>فیلترهای جستجو</h5>
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label class="form-label">از تاریخ</label>
                            <input type="date" class="form-control" id="fromDate">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">تا تاریخ</label>
                            <input type="date" class="form-control" id="toDate">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ارز</label>
                            <select class="form-select" id="currency">
                                <option value="">همه</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="AED">AED</option>
                                <option value="IRR">IRR</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">مشتری</label>
                            <select class="form-select" id="customer">
                                <option value="">همه</option>
                                <!-- Customer options will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-warning w-100" onclick="loadDocumentReports()">
                                <i class="fas fa-search me-1"></i>جستجو
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Documents Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>جدول تفصیلی اسناد</h5>
                    <button class="btn btn-success btn-sm" onclick="exportDocumentData()">
                        <i class="fas fa-file-excel me-1"></i>خروجی Excel
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="documentsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th class="sortable" data-column="id">شناسه <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="date">تاریخ <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="type">نوع سند <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="customerName">مشتری <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="sortable" data-column="amount">مبلغ <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="description">شرح <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-column="status">وضعیت <i class="fas fa-sort"></i></th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="documentsTableBody">
                                <tr>
                                    <td colspan="8" class="text-center py-5">
                                        <div class="spinner-border text-warning" role="status">
                                            <span class="visually-hidden">در حال بارگذاری...</span>
                                        </div>
                                        <p class="mt-2 text-muted">در حال بارگذاری اطلاعات...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let documentsData = []; // Store documents data for sorting
    let currentSort = { column: null, direction: 'asc' };

    document.addEventListener('DOMContentLoaded', function () {
        // Set default dates
        const today = new Date();
        const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());

        document.getElementById('fromDate').value = lastMonth.toISOString().split('T')[0];
        document.getElementById('toDate').value = today.toISOString().split('T')[0];

        // Add click event listeners to sortable headers
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function () {
                const column = this.getAttribute('data-column');
                sortTable(column);
            });
            header.style.cursor = 'pointer';
        });

        loadDocumentReports();
    });

    function loadDocumentReports() {
        loadDocumentsTable();
    }

    function loadDocumentsTable() {
        const tbody = document.getElementById('documentsTableBody');
        tbody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-5">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">در حال بارگذاری...</span>
                </div>
                <p class="mt-2 text-muted">در حال بارگذاری اطلاعات اسناد...</p>
            </td>
        </tr>
    `;

        const fromDate = document.getElementById('fromDate').value;
        const toDate = document.getElementById('toDate').value;
        const currency = document.getElementById('currency').value;
        const customer = document.getElementById('customer').value;

        let url = `@Url.Action("GetDocumentsData", "Reports")?fromDate=${fromDate}&toDate=${toDate}`;
        if (currency) url += `&currency=${currency}`;
        if (customer) url += `&customer=${customer}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5 text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${data.error}
                        </td>
                    </tr>
                `;
                    return;
                }

                tbody.innerHTML = '';

                if (data.documents && data.documents.length > 0) {
                    documentsData = data.documents; // Store data for sorting
                    renderDocumentsTable(documentsData);
                } else {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5 text-muted">
                            <i class="fas fa-info-circle"></i>
                            هیچ سندی در این بازه زمانی یافت نشد
                        </td>
                    </tr>
                `;
                }
            })
            .catch(error => {
                console.error('Error loading documents table:', error);
                tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-5 text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        خطا در بارگذاری اطلاعات
                    </td>
                </tr>
            `;
            });
    }

    function renderDocumentsTable(documents) {
        const tbody = document.getElementById('documentsTableBody');
        tbody.innerHTML = '';

        documents.forEach(doc => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>DOC${doc.id.toString().padStart(3, '0')}</td>
            <td>${new Date(doc.date).toLocaleDateString('en-GB')}</td>
            <td><span class="badge bg-warning">${doc.type}</span></td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-warning text-white rounded-circle me-2 d-flex align-items-center justify-content-center">
                        ${doc.customerName.charAt(0)}
                    </div>
                    ${doc.customerName}
                </div>
            </td>
            <td>${formatNumber(doc.amount)}</td>
            <td>${doc.description}</td>
            <td>
                <span class="badge bg-success">
                    ${doc.status}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewDocumentDetails(${doc.id})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
            tbody.appendChild(row);
        });
    }

    function sortTable(column) {
        // Toggle sort direction
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
        }

        // Update sort icons
        document.querySelectorAll('.sortable i').forEach(icon => {
            icon.className = 'fas fa-sort';
        });

        const currentHeader = document.querySelector(`[data-column="${column}"] i`);
        if (currentSort.direction === 'asc') {
            currentHeader.className = 'fas fa-sort-up';
        } else {
            currentHeader.className = 'fas fa-sort-down';
        }

        // Sort the data
        const sortedData = [...documentsData].sort((a, b) => {
            let valueA = a[column];
            let valueB = b[column];

            // Handle different data types
            if (column === 'date') {
                valueA = new Date(valueA);
                valueB = new Date(valueB);
            } else if (column === 'amount' || column === 'id') {
                valueA = parseFloat(valueA) || 0;
                valueB = parseFloat(valueB) || 0;
            } else {
                valueA = valueA.toString().toLowerCase();
                valueB = valueB.toString().toLowerCase();
            }

            if (currentSort.direction === 'asc') {
                return valueA > valueB ? 1 : -1;
            } else {
                return valueA < valueB ? 1 : -1;
            }
        });

        renderDocumentsTable(sortedData);
    }

    function viewDocumentDetails(docId) {
        alert('مشاهده جزئیات سند: ' + docId);
    }

    function exportDocumentData() {
        window.location.href = '@Url.Action("ExportToExcel", "Reports")?type=documents';
    }

    function formatNumber(num) {
        if (num === 0) return '0';
        return num.toLocaleString('fa-IR');
    }
</script>

<style>
    .avatar-sm {
        width: 32px;
        height: 32px;
        font-size: 0.875rem;
    }

    .table th {
        border-top: none;
        font-weight: 600;
    }

    .card {
        border-radius: 10px;
    }

    .badge {
        font-size: 0.75rem;
    }

    .sortable {
        cursor: pointer;
        user-select: none;
    }

    .sortable i {
        margin-left: 5px;
        opacity: 0.7;
    }
</style>