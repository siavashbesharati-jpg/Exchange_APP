@{
    ViewData["Title"] = "گزارشات مالی";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-chart-bar text-primary me-2"></i>گزارشات مالی جامع</h2>
            <p class="text-muted">مشاهده و تحلیل کامل اطلاعات مالی، معاملات، تراز مشتریان و حساب‌های بانکی</p>
        </div>
    </div>

    <!-- Advanced Filters -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>فیلترهای پیشرفته</h5>
        </div>
        <div class="card-body">
            <form id="reportFilters">
                <div class="row g-3">
                    <!-- Date Range -->
                    <div class="col-md-3">
                        <label class="form-label">از تاریخ</label>
                        <input type="date" class="form-control" id="fromDate" name="fromDate" value="@DateTime.Now.AddDays(-30).ToString("yyyy-MM-dd")">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">تا تاریخ</label>
                        <input type="date" class="form-control" id="toDate" name="toDate" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                    </div>
                    
                    <!-- Customer Filter -->
                    <div class="col-md-3">
                        <label class="form-label">مشتری</label>
                        <select class="form-select" id="customerId" name="customerId">
                            <option value="">همه مشتریان</option>
                            <!-- Will be populated via AJAX -->
                        </select>
                    </div>
                    
                    <!-- Currency Filter -->
                    <div class="col-md-3">
                        <label class="form-label">ارز</label>
                        <select class="form-select" id="currencyId" name="currencyId">
                            <option value="">همه ارزها</option>
                            <!-- Will be populated via AJAX -->
                        </select>
                    </div>
                    
                    <!-- Bank Account Filter -->
                    <div class="col-md-3">
                        <label class="form-label">حساب بانکی</label>
                        <select class="form-select" id="bankAccountId" name="bankAccountId">
                            <option value="">همه حساب‌ها</option>
                            <!-- Will be populated via AJAX -->
                        </select>
                    </div>
                    
                    <!-- Report Type -->
                    <div class="col-md-3">
                        <label class="form-label">نوع گزارش</label>
                        <select class="form-select" id="reportType" name="reportType">
                            <option value="all">همه گزارشات</option>
                            <option value="orders">معاملات مشتریان</option>
                            <option value="balances">تراز مشتریان</option>
                            <option value="bank_balances">موجودی بانک‌ها</option>
                        </select>
                    </div>
                    
                    <!-- Order Status Filter -->
                    <div class="col-md-3">
                        <label class="form-label">وضعیت معامله</label>
                        <select class="form-select" id="orderStatus" name="orderStatus">
                            <option value="">همه وضعیت‌ها</option>
                            <option value="Pending">در انتظار</option>
                            <option value="Completed">تکمیل شده</option>
                            <option value="Cancelled">لغو شده</option>
                        </select>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="button" class="btn btn-primary me-2" onclick="applyFilters()">
                            <i class="fas fa-search me-1"></i>اعمال فیلتر
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                            <i class="fas fa-undo me-1"></i>پاک کردن
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Summary Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">کل معاملات</h6>
                            <h3 id="totalOrders" dir="ltr">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clipboard-list fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">حجم معاملات</h6>
                            <h3 id="totalVolume" dir="ltr">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-dollar-sign fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">مشتریان فعال</h6>
                            <h3 id="activeCustomers" dir="ltr">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">تراز کل سیستم</h6>
                            <h3 id="systemBalance" dir="ltr">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-balance-scale fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Tabs -->
    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="reportTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders-panel" type="button" role="tab">
                        <i class="fas fa-clipboard-list me-1"></i>معاملات مشتریان
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="balances-tab" data-bs-toggle="tab" data-bs-target="#balances-panel" type="button" role="tab">
                        <i class="fas fa-user-friends me-1"></i>تراز مشتریان
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="bank-balances-tab" data-bs-toggle="tab" data-bs-target="#bank-balances-panel" type="button" role="tab">
                        <i class="fas fa-university me-1"></i>موجودی بانک‌ها
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts-panel" type="button" role="tab">
                        <i class="fas fa-chart-pie me-1"></i>نمودارها
                    </button>
                </li>
            </ul>
        </div>
        
        <div class="card-body">
            <div class="tab-content" id="reportTabContent">
                <!-- Customer Orders Tab -->
                <div class="tab-pane fade show active" id="orders-panel" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-clipboard-list text-primary me-2"></i>معاملات مشتریان</h5>
                        <button class="btn btn-outline-success btn-sm" onclick="exportToExcel('orders')">
                            <i class="fas fa-file-excel me-1"></i>خروجی Excel
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="ordersTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>شناسه</th>
                                    <th>تاریخ</th>
                                    <th>مشتری</th>
                                    <th>نوع معامله</th>
                                    <th>ارز مبدا</th>
                                    <th>مقدار</th>
                                    <th>ارز مقصد</th>
                                    <th>نرخ</th>
                                    <th>وضعیت</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="10" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">در حال بارگذاری...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Customer Balances Tab -->
                <div class="tab-pane fade" id="balances-panel" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-user-friends text-success me-2"></i>تراز مشتریان</h5>
                        <button class="btn btn-outline-success btn-sm" onclick="exportToExcel('balances')">
                            <i class="fas fa-file-excel me-1"></i>خروجی Excel
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="balancesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>مشتری</th>
                                    <th>ارز</th>
                                    <th>تراز</th>
                                    <th>وضعیت</th>
                                    <th>آخرین بروزرسانی</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <div class="spinner-border text-success" role="status">
                                            <span class="visually-hidden">در حال بارگذاری...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Bank Balances Tab -->
                <div class="tab-pane fade" id="bank-balances-panel" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-university text-info me-2"></i>موجودی حساب‌های بانکی</h5>
                        <button class="btn btn-outline-success btn-sm" onclick="exportToExcel('bank_balances')">
                            <i class="fas fa-file-excel me-1"></i>خروجی Excel
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="bankBalancesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>بانک</th>
                                    <th>شماره حساب</th>
                                    <th>ارز</th>
                                    <th>موجودی</th>
                                    <th>وضعیت</th>
                                    <th>آخرین بروزرسانی</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border text-info" role="status">
                                            <span class="visually-hidden">در حال بارگذاری...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Charts Tab -->
                <div class="tab-pane fade" id="charts-panel" role="tabpanel">
                    <h5><i class="fas fa-chart-pie text-warning me-2"></i>نمودارها و تحلیل‌ها</h5>
                    
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6>حجم معاملات بر اساس ارز</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="currencyVolumeChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6>روند معاملات روزانه</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="dailyTrendChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6>توزیع تراز مشتریان</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="customerBalanceChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6>موجودی بانک‌ها</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="bankBalanceChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let ordersChart, balancesChart, bankChart, trendChart;
        
        $(document).ready(function() {
            loadFilterOptions();
            loadQuickSummary();
            loadOrdersData();
            initializeCharts();
        });

        // Load filter dropdown options
        function loadFilterOptions() {
            // Load customers
            $.get('/api/customers', function(data) {
                const customerSelect = $('#customerId');
                customerSelect.empty().append('<option value="">همه مشتریان</option>');
                data.forEach(customer => {
                    customerSelect.append(`<option value="${customer.id}">${customer.fullName}</option>`);
                });
            });

            // Load currencies
            $.get('/api/currencies', function(data) {
                const currencySelect = $('#currencyId');
                currencySelect.empty().append('<option value="">همه ارزها</option>');
                data.forEach(currency => {
                    currencySelect.append(`<option value="${currency.id}">${currency.name} (${currency.code})</option>`);
                });
            });

            // Load bank accounts
            $.get('/api/bankaccounts', function(data) {
                const bankSelect = $('#bankAccountId');
                bankSelect.empty().append('<option value="">همه حساب‌ها</option>');
                data.forEach(account => {
                    bankSelect.append(`<option value="${account.id}">${account.bankName} - ${account.accountNumber}</option>`);
                });
            });
        }

        // Load quick summary cards
        function loadQuickSummary() {
            const filters = getFilterData();
            console.log('Loading quick summary with filters:', filters); // Debug log
            $.post('/Reports/GetQuickSummary', filters, function(data) {
                console.log('Quick summary data received:', data); // Debug log
                $('#totalOrders').text(data.totalOrders?.toLocaleString() || '0');
                $('#totalVolume').text((data.totalVolume?.toLocaleString() || '0') + ' تومان');
                $('#activeCustomers').text(data.activeCustomers?.toLocaleString() || '0');
                $('#systemBalance').text((data.systemBalance?.toLocaleString() || '0') + ' تومان');
            }).fail(function(xhr, status, error) {
                console.error('Error loading quick summary:', error, xhr.responseText); // Debug log
            });
        }

        // Get current filter data
        function getFilterData() {
            return {
                fromDate: $('#fromDate').val(),
                toDate: $('#toDate').val(),
                customerId: $('#customerId').val() || null,
                currencyId: $('#currencyId').val() || null,
                bankAccountId: $('#bankAccountId').val() || null,
                orderStatus: $('#orderStatus').val() || null,
                reportType: $('#reportType').val()
            };
        }

        // Apply filters
        function applyFilters() {
            loadQuickSummary();
            loadOrdersData();
            loadBalancesData();
            loadBankBalancesData();
            updateCharts();
        }

        // Reset filters
        function resetFilters() {
            $('#reportFilters')[0].reset();
            $('#fromDate').val('@DateTime.Now.AddDays(-30).ToString("yyyy-MM-dd")');
            $('#toDate').val('@DateTime.Now.ToString("yyyy-MM-dd")');
            applyFilters();
        }

        // Load orders data
        function loadOrdersData() {
            const filters = getFilterData();
            console.log('Loading orders with filters:', filters); // Debug log
            $('#ordersTable tbody').html('<tr><td colspan="10" class="text-center"><div class="spinner-border text-primary" role="status"></div></td></tr>');
            
            $.post('/Reports/GetOrdersData', filters, function(data) {
                console.log('Orders data received:', data); // Debug log
                let html = '';
                if (data && data.length > 0) {
                    data.forEach(order => {
                        const statusBadge = getStatusBadge(order.status);
                        html += `
                            <tr>
                                <td>${order.id}</td>
                                <td>${new Date(order.createdAt).toLocaleDateString('fa-IR')}</td>
                                <td>${order.customerName}</td>
                                <td>${order.orderType}</td>
                                <td>${order.fromCurrency}</td>
                                <td dir="ltr">${order.amount?.toLocaleString()}</td>
                                <td>${order.toCurrency}</td>
                                <td dir="ltr">${order.exchangeRate?.toLocaleString()}</td>
                                <td>${statusBadge}</td>
                                <td>
                                    <a href="/Orders/Details/${order.id}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>`;
                    });
                } else {
                    html = '<tr><td colspan="10" class="text-center">هیچ رکوردی یافت نشد</td></tr>';
                }
                $('#ordersTable tbody').html(html);
            }).fail(function(xhr, status, error) {
                console.error('Error loading orders:', error, xhr.responseText); // Debug log
                $('#ordersTable tbody').html('<tr><td colspan="10" class="text-center text-danger">خطا در بارگذاری داده‌ها</td></tr>');
            });
        }

        // Load balances data
        function loadBalancesData() {
            const filters = getFilterData();
            $('#balancesTable tbody').html('<tr><td colspan="6" class="text-center"><div class="spinner-border text-success" role="status"></div></td></tr>');
            
            $.post('/Reports/GetBalancesData', filters, function(data) {
                let html = '';
                if (data && data.length > 0) {
                    data.forEach(balance => {
                        const balanceBadge = getBalanceBadge(balance.balance);
                        html += `
                            <tr>
                                <td>${balance.customerName}</td>
                                <td>${balance.currencyCode}</td>
                                <td dir="ltr">${balance.balance?.toLocaleString()}</td>
                                <td>${balanceBadge}</td>
                                <td>${new Date(balance.lastUpdated).toLocaleDateString('fa-IR')}</td>
                                <td>
                                    <a href="/Customers/Details/${balance.customerId}" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-user"></i>
                                    </a>
                                </td>
                            </tr>`;
                    });
                } else {
                    html = '<tr><td colspan="6" class="text-center">هیچ رکوردی یافت نشد</td></tr>';
                }
                $('#balancesTable tbody').html(html);
            });
        }

        // Load bank balances data
        function loadBankBalancesData() {
            const filters = getFilterData();
            $('#bankBalancesTable tbody').html('<tr><td colspan="7" class="text-center"><div class="spinner-border text-info" role="status"></div></td></tr>');
            
            $.post('/Reports/GetBankBalancesData', filters, function(data) {
                let html = '';
                if (data && data.length > 0) {
                    data.forEach(account => {
                        const balanceBadge = getBalanceBadge(account.balance);
                        html += `
                            <tr>
                                <td>${account.bankName}</td>
                                <td>${account.accountNumber}</td>
                                <td>${account.currencyCode}</td>
                                <td dir="ltr">${account.balance?.toLocaleString()}</td>
                                <td>${balanceBadge}</td>
                                <td>${new Date(account.lastUpdated).toLocaleDateString('fa-IR')}</td>
                                <td>
                                    <a href="/BankAccount/Details/${account.id}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-university"></i>
                                    </a>
                                </td>
                            </tr>`;
                    });
                } else {
                    html = '<tr><td colspan="7" class="text-center">هیچ رکوردی یافت نشد</td></tr>';
                }
                $('#bankBalancesTable tbody').html(html);
            });
        }

        // Get status badge
        function getStatusBadge(status) {
            const badges = {
                'Pending': '<span class="badge bg-warning">در انتظار</span>',
                'Completed': '<span class="badge bg-success">تکمیل شده</span>',
                'Cancelled': '<span class="badge bg-danger">لغو شده</span>',
                'Processing': '<span class="badge bg-info">در حال پردازش</span>'
            };
            return badges[status] || '<span class="badge bg-secondary">نامشخص</span>';
        }

        // Get balance badge
        function getBalanceBadge(balance) {
            if (balance > 0) {
                return '<span class="badge bg-success">بستانکار</span>';
            } else if (balance < 0) {
                return '<span class="badge bg-danger">بدهکار</span>';
            } else {
                return '<span class="badge bg-secondary">صفر</span>';
            }
        }

        // Initialize charts
        function initializeCharts() {
            // Currency volume chart
            const currencyCtx = document.getElementById('currencyVolumeChart').getContext('2d');
            ordersChart = new Chart(currencyCtx, {
                type: 'doughnut',
                data: {
                    labels: ['دلار', 'یورو', 'درهم', 'تومان'],
                    datasets: [{
                        data: [40, 30, 20, 10],
                        backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545']
                    }]
                }
            });

            // Daily trend chart
            const trendCtx = document.getElementById('dailyTrendChart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: ['شنبه', 'یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه'],
                    datasets: [{
                        label: 'حجم معاملات',
                        data: [12, 19, 15, 17, 14, 22, 18],
                        borderColor: '#007bff',
                        fill: false
                    }]
                }
            });

            // Customer balance chart
            const customerCtx = document.getElementById('customerBalanceChart').getContext('2d');
            balancesChart = new Chart(customerCtx, {
                type: 'bar',
                data: {
                    labels: ['بستانکار', 'بدهکار', 'صفر'],
                    datasets: [{
                        data: [25, 15, 10],
                        backgroundColor: ['#28a745', '#dc3545', '#6c757d']
                    }]
                }
            });

            // Bank balance chart
            const bankCtx = document.getElementById('bankBalanceChart').getContext('2d');
            bankChart = new Chart(bankCtx, {
                type: 'bar',
                data: {
                    labels: ['ملی', 'پارسیان', 'سامان', 'پاسارگاد'],
                    datasets: [{
                        label: 'موجودی (میلیون تومان)',
                        data: [150, 120, 90, 80],
                        backgroundColor: '#17a2b8'
                    }]
                }
            });
        }

        // Update charts with filtered data
        function updateCharts() {
            const filters = getFilterData();
            
            // Update charts with real data from server
            $.post('/Reports/GetChartsData', filters, function(data) {
                // Update currency volume chart
                if (data.currencyVolume) {
                    ordersChart.data.labels = data.currencyVolume.labels;
                    ordersChart.data.datasets[0].data = data.currencyVolume.data;
                    ordersChart.update();
                }

                // Update daily trend chart
                if (data.dailyTrend) {
                    trendChart.data.labels = data.dailyTrend.labels;
                    trendChart.data.datasets[0].data = data.dailyTrend.data;
                    trendChart.update();
                }

                // Update customer balance chart
                if (data.customerBalance) {
                    balancesChart.data.datasets[0].data = data.customerBalance.data;
                    balancesChart.update();
                }

                // Update bank balance chart
                if (data.bankBalance) {
                    bankChart.data.labels = data.bankBalance.labels;
                    bankChart.data.datasets[0].data = data.bankBalance.data;
                    bankChart.update();
                }
            });
        }

        // Export to Excel
        function exportToExcel(type) {
            const filters = getFilterData();
            const params = new URLSearchParams(filters);
            window.open(`/Reports/ExportToExcel?type=${type}&${params}`, '_blank');
        }

        // Tab change event
        $('#reportTabs button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            const target = e.target.getAttribute('data-bs-target');
            
            if (target === '#balances-panel') {
                loadBalancesData();
            } else if (target === '#bank-balances-panel') {
                loadBankBalancesData();
            } else if (target === '#charts-panel') {
                updateCharts();
            }
        });
    </script>
}

@section Styles {
    <style>
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
        
        .card-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
        }
        
        .table th {
            border-top: none;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .badge {
            font-size: 0.75rem;
        }
        
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
        }
        
        .nav-tabs .nav-link.active {
            background-color: transparent;
            border-bottom: 3px solid #007bff;
            color: #007bff;
        }
    </style>
}
