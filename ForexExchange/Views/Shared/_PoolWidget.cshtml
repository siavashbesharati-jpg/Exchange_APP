@model List<ForexExchange.Models.CurrencyPool>
@using ForexExchange.Services

<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <i class="bi bi-bank"></i> Ø§Ø³ØªØ®Ø± Ø§Ø±Ø²ÛŒ - Currency Pool
        <div class="float-end">
            <small id="pool-last-update">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: @DateTime.Now.ToString("HH:mm:ss")</small>
        </div>
    </div>
    <div class="card-body">
        @if (Model != null && Model.Any())
        {
            <div class="row">
                @foreach (var pool in Model)
                {
                    var riskColorClass = pool.RiskLevel switch
                    {
                        ForexExchange.Models.PoolRiskLevel.Low => "success",
                        ForexExchange.Models.PoolRiskLevel.Medium => "warning",
                        ForexExchange.Models.PoolRiskLevel.High => "danger",
                        ForexExchange.Models.PoolRiskLevel.Critical => "dark",
                        _ => "secondary"
                    };

                    var balanceColorClass = pool.Balance >= 0 ? "success" : "danger";
                    var balanceIcon = pool.Balance >= 0 ? "bi-arrow-up-circle" : "bi-arrow-down-circle";
                
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card border-@riskColorClass">
                            <div class="card-body text-center">
                                <h5 class="card-title">
                                    <span class="currency-flag">
                                        @switch (pool.Currency)
                                        {
                                            case "USD": <span>ğŸ‡ºğŸ‡¸</span> break;
                                            case "EUR": <span>ğŸ‡ªğŸ‡º</span> break;
                                            case "AED": <span>ğŸ‡¦ğŸ‡ª</span> break;
                                            case "OMR": <span>ğŸ‡´ğŸ‡²</span> break;
                                            case "TRY": <span>ğŸ‡¹ğŸ‡·</span> break;
                                            default: <span>ğŸ’±</span> break;
                                        }
                                    </span>
                                    @pool.Currency
                                </h5>
                                
                                <div class="balance-display">
                                    <h3 class="text-@balanceColorClass">
                                        <i class="bi @balanceIcon"></i>
                                        @pool.Balance.ToString("N2")
                                    </h3>
                                    <small class="text-muted">Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ</small>
                                </div>

                                <div class="pool-stats mt-3">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="stat-item">
                                                <strong class="text-success">@pool.TotalBought.ToString("N0")</strong>
                                                <br><small>Ø®Ø±ÛŒØ¯</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="stat-item">
                                                <strong class="text-danger">@pool.TotalSold.ToString("N0")</strong>
                                                <br><small>ÙØ±ÙˆØ´</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="risk-indicator mt-3">
                                    <span class="badge bg-@riskColorClass">
                                        @switch (pool.RiskLevel)
                                        {
                                            case ForexExchange.Models.PoolRiskLevel.Low: <text>Ø±ÛŒØ³Ú© Ú©Ù…</text> break;
                                            case ForexExchange.Models.PoolRiskLevel.Medium: <text>Ø±ÛŒØ³Ú© Ù…ØªÙˆØ³Ø·</text> break;
                                            case ForexExchange.Models.PoolRiskLevel.High: <text>Ø±ÛŒØ³Ú© Ø¨Ø§Ù„Ø§</text> break;
                                            case ForexExchange.Models.PoolRiskLevel.Critical: <text>Ø±ÛŒØ³Ú© Ø¨Ø­Ø±Ø§Ù†ÛŒ</text> break;
                                            default: <text>Ù†Ø§Ù…Ø´Ø®Øµ</text> break;
                                        }
                                    </span>
                                </div>

                                @if (pool.AverageBuyRate.HasValue || pool.AverageSellRate.HasValue)
                                {
                                    <div class="rate-info mt-2">
                                        <small class="text-muted">
                                            @if (pool.AverageBuyRate.HasValue)
                                            {
                                                <span>Ø®Ø±ÛŒØ¯: @pool.AverageBuyRate.Value.ToString("N0")</span>
                                            }
                                            @if (pool.AverageBuyRate.HasValue && pool.AverageSellRate.HasValue)
                                            {
                                                <span> | </span>
                                            }
                                            @if (pool.AverageSellRate.HasValue)
                                            {
                                                <span>ÙØ±ÙˆØ´: @pool.AverageSellRate.Value.ToString("N0")</span>
                                            }
                                        </small>
                                    </div>
                                }

                                <div class="last-update mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i>
                                        @pool.LastUpdated.ToString("dd/MM HH:mm")
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Summary Row -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="alert alert-info">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <strong>@Model.Count</strong><br>
                                <small>ØªØ¹Ø¯Ø§Ø¯ Ø§Ø±Ø²Ù‡Ø§</small>
                            </div>
                            <div class="col-md-3">
                                <strong>@Model.Count(p => p.Balance > 0)</strong><br>
                                <small>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…Ø«Ø¨Øª</small>
                            </div>
                            <div class="col-md-3">
                                <strong>@Model.Count(p => p.Balance < 0)</strong><br>
                                <small>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…Ù†ÙÛŒ</small>
                            </div>
                            <div class="col-md-3">
                                <strong>@Model.Count(p => p.RiskLevel >= ForexExchange.Models.PoolRiskLevel.High)</strong><br>
                                <small>Ø±ÛŒØ³Ú© Ø¨Ø§Ù„Ø§</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Auto Refresh Controls -->
            <div class="row mt-2">
                <div class="col-12 text-center">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="refreshPoolWidget()">
                            <i class="bi bi-arrow-clockwise"></i> Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="auto-refresh-toggle" onclick="toggleAutoRefresh()">
                            <i class="bi bi-play-circle"></i> Ø®ÙˆØ¯Ú©Ø§Ø±
                        </button>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="text-center text-muted py-4">
                <i class="bi bi-bank" style="font-size: 2rem;"></i>
                <p class="mt-2">Ù‡ÛŒÚ† Ø§Ø³ØªØ®Ø± Ø§Ø±Ø²ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>
                <small>Ø§Ø³ØªØ®Ø±Ù‡Ø§ÛŒ Ø§Ø±Ø²ÛŒ Ù¾Ø³ Ø§Ø² Ø§ÙˆÙ„ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</small>
            </div>
        }
    </div>
</div>

<style>
.currency-flag {
    font-size: 1.2em;
    margin-left: 0.5rem;
}

.balance-display h3 {
    margin: 0.5rem 0;
    font-weight: bold;
}

.stat-item {
    padding: 0.25rem;
}

.risk-indicator {
    margin: 0.5rem 0;
}

.pool-stats .row {
    margin: 0;
}

.last-update {
    font-size: 0.75rem;
}

.card.border-success { border-color: #198754 !important; }
.card.border-warning { border-color: #ffc107 !important; }
.card.border-danger { border-color: #dc3545 !important; }
.card.border-dark { border-color: #212529 !important; }
</style>

<script>
let autoRefreshInterval = null;
let isAutoRefreshActive = false;

function refreshPoolWidget() {
    $.get('/Home/PoolWidget', function(data) {
        $('#pool-widget-container').html(data);
        $('#pool-last-update').text('Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ' + new Date().toLocaleTimeString('fa-IR'));
    }).fail(function() {
        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆÛŒØ¬Øª Ø§Ø³ØªØ®Ø±');
    });
}

function toggleAutoRefresh() {
    const button = $('#auto-refresh-toggle');
    
    if (isAutoRefreshActive) {
        clearInterval(autoRefreshInterval);
        isAutoRefreshActive = false;
        button.html('<i class="bi bi-play-circle"></i> Ø®ÙˆØ¯Ú©Ø§Ø±');
        button.removeClass('btn-success').addClass('btn-outline-secondary');
    } else {
        autoRefreshInterval = setInterval(refreshPoolWidget, 30000); // Refresh every 30 seconds
        isAutoRefreshActive = true;
        button.html('<i class="bi bi-stop-circle"></i> ØªÙˆÙ‚Ù');
        button.removeClass('btn-outline-secondary').addClass('btn-success');
    }
}

// Auto-refresh on page load if enabled
$(document).ready(function() {
    // Optional: Start auto-refresh by default
    // toggleAutoRefresh();
});
</script>
