# راهنمای مدیریت OTP مبتنی بر Authenticator

این سند توضیح می‌دهد چگونه مدیر سیستم برای کاربران فعلی کد یکبارمصرف (TOTP) فعال کند و آن را در اختیارشان بگذارد.

## 1. ایجاد Secret جدید

1. وارد مسیر ریشه پروژه شوید:
   ```
   cd E:\IRANEXPEDIA\Exsora\Exchange_APP
   ```
2. از `dotnet script` یا هر محیط C# Interactive دیگری استفاده کنید و اسکریپت زیر را اجرا کنید:
   ```csharp
   #r "nuget: Otp.NET, 1.4.0"
   using OtpNet;

   var secret = Base32Encoding.ToString(KeyGeneration.GenerateRandomKey(20));
   Console.WriteLine(secret);
   ```
   خروجی یک رشته Base32 (مثل `JBSWY3DPEHPK3PXP`) خواهد بود. این مقدار را یادداشت کنید؛ این همان Secret کاربر است.

> نکته: می‌توانید همین کد را داخل Immediate Window ویژوال استودیو یا هر ابزار C# دیگری اجرا کنید.

## 2. ثبت Secret برای کاربر

Secret باید در جدول کاربران (`AspNetUsers`) ذخیره شود. برای هر کاربر:

1. شماره تلفن کاربر را با تابع نرمال‌سازی سیستم به فرمت بین‌المللی (مانند `0098...`) تبدیل کنید.
2. مقادیر زیر را در پایگاه داده به‌روزرسانی کنید:
   ```sql
   UPDATE AspNetUsers
   SET TotpSecret = '{SECRET_BASE32}',
       TotpSecretUpdatedAt = CURRENT_TIMESTAMP
   WHERE UserName = '{NORMALIZED_PHONE}';
   ```
3. اگر کاربر در سیستم وارد است، از او بخواهید خارج شده و دوباره با OTP وارد شود.

> هشدار امنیتی: Secret را فقط از طریق کانال امن به‌کاربر منتقل کنید و پس از راه‌اندازی، آن را ذخیره نکنید.

## 3. راه‌اندازی در Authenticator کاربر

به کاربر یکی از گزینه‌های زیر را بدهید:

- **ورود دستی Secret**: کاربر Secret Base32 را در اپلیکیشنی مثل Google Authenticator وارد کند.
- **استفاده از QR Code**: با فرمت URI زیر یک QR بسازید:
  ```
  otpauth://totp/Exsora:{DISPLAY_PHONE}?secret={SECRET_BASE32}&issuer=Exsora&digits=6&period=30
  ```
  مقدارهای `{DISPLAY_PHONE}` و `{SECRET_BASE32}` را جایگزین کنید. می‌توانید از هر ابزار تولید QR استفاده کنید.

## 4. تست و پشتیبانی

1. از کاربر بخواهید یک کد ۶ رقمی از اپلیکیشن خود قرائت کرده و در صفحه ورود وارد کند.
2. در صورت موفقیت، `TotpSecretUpdatedAt` مقدار جدید خواهد داشت و کاربر بدون رمز عبور وارد می‌شود.
3. اگر کاربر کد اشتباه وارد کند، حساب پس از ۵ تلاش ناموفق قفل خواهد شد. در این صورت:
   - مدیر می‌تواند با اجرای دستور زیر شمارنده خطا را ریست کند:
     ```csharp
     await userManager.ResetAccessFailedCountAsync(user);
     ```

## 5. نکات تکمیلی

- Secret را برای هر کاربر منحصر به‌فرد نگه دارید.
- در حالت دمو، اگر Secret تعریف شده باشد، صفحه ورود یک کد جاری نمایش می‌دهد تا تست سریع انجام شود.
- برای کاربران جدید (ثبت‌نام یا ساخت دستی)، پس از ایجاد حساب بلافاصله Secret تولید و در بانک اطلاعاتی ثبت کنید.

با رعایت مراحل بالا، ورود بدون رمز عبور و مبتنی بر TOTP برای کاربران فعال خواهد شد.

